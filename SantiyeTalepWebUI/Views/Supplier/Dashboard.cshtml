@model SantiyeTalepWebUI.Models.ViewModels.SupplierDashboardViewModel
@{
    ViewData["Title"] = "Tedarikçi Dashboard";
    Layout = "~/Views/Shared/_SupplierLayout.cshtml";
}

<!-- Add notification checker styles -->
@section Styles {
    <link href="~/css/notification-checker.css" rel="stylesheet" />
    <style>
        /* Notification Panel Styles */
        .notification-panel {
            display: none;
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .notification-panel.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @@keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .notification-panel-header {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            justify-content: between;
        }

        .notification-panel-body {
            max-height: 400px;
            overflow-y: auto;
        }

        .notification-item {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #f8f9fa;
            transition: background-color 0.2s ease;
            cursor: pointer;
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
        }

        .notification-item:hover {
            background-color: #f8f9fa;
        }

        .notification-item:last-child {
            border-bottom: none;
        }

        .notification-item.unread {
            border-left: 4px solid #ffc107;
        }

        .notification-item.unread:hover {
            background-color: #ffeaa7;
        }

        .notification-content {
            flex-grow: 1;
        }

        .notification-meta {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .notification-type-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .notification-actions {
            display: flex;
            gap: 0.5rem;
            align-items: flex-start;
            margin-left: 1rem;
            flex-shrink: 0;
        }

        .btn-mark-read {
            font-size: 11px;
            padding: 0.25rem 0.5rem;
        }

        .notification-panel-footer {
            padding: 1rem 1.5rem;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            text-align: center;
        }

        .notification-empty {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
        }

        .notification-title-link {
            color: #2385ba;
            text-decoration: none;
        }

        .notification-title-link:hover {
            color: #1d6fa3;
            text-decoration: underline;
        }

        /* **YENİ: Toast animasyonları** */
        @@keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @@keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* **YENİ: Custom toast stili** */
        .custom-toast {
            font-family: inherit;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

            .custom-toast:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 16px rgba(0,0,0,0.2);
            }

        /* **YENİ: Bootstrap toast özelleştirme** */
        .toast.bg-warning {
            background: linear-gradient(135deg, #ffc107, #ff9800) !important;
        }

        .notification-toast {
            cursor: pointer;
        }

        /* Diğer mevcut stiller... */
    </style>
}

<div class="main-content" data-enable-notifications="true">
    <div class="page-content">
        <div class="container-fluid">
            
            <!-- Page Title -->
            <div class="row">
                <div class="col-12">
                    <div class="page-title-box d-sm-flex align-items-center justify-content-between">
                        <h4 class="mb-sm-0">Tedarikçi Dashboard</h4>
                        <div class="page-title-right">
                            <ol class="breadcrumb m-0">
                                <li class="breadcrumb-item active">Dashboard</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>

            @if (TempData["SuccessMessage"] != null)
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    @TempData["SuccessMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            @if (TempData["ErrorMessage"] != null)
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    @TempData["ErrorMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            <!-- Notification Alert for New Requests -->
            @if (Model.NotificationSummary != null && Model.NotificationSummary.UnreadCount > 0)
            {
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="alert alert-info alert-dismissible fade show" role="alert" id="notificationAlert">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0 me-3">
                                    <i class="ri-notification-3-line fs-24 text-info"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="alert-heading mb-1">Yeni Bildirimleriniz Var!</h6>
                                    <p class="mb-0">
                                        <a href="javascript:void(0)" onclick="toggleNotifications()" class="alert-link fw-semibold">Bildirimleri görüntülemek için tıklayın</a>.
                                    </p>
                                </div>
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        </div>
                    </div>
                </div>
            }

            <!-- Notification Panel (Initially Hidden) -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="notification-panel" id="notificationPanel">
                        <div class="notification-panel-header">
                            <div class="d-flex align-items-center flex-grow-1">
                                <i class="ri-notification-3-line fs-20 text-primary me-2"></i>
                                <h5 class="mb-0">Bildirimlerim</h5>
                                @if (Model.NotificationSummary != null && Model.NotificationSummary.UnreadCount > 0)
                                {
                                    <span class="badge bg-danger ms-2 notifications-count">@Model.NotificationSummary.UnreadCount</span>
                                }
                            </div>
                            <div class="d-flex gap-2">
                                @if (Model.NotificationSummary != null && Model.NotificationSummary.UnreadCount > 0)
                                {
                                    <button class="btn btn-sm btn-outline-primary" onclick="markAllAsRead()">
                                        <i class="ri-check-double-line"></i> Tümünü Okundu Olarak İşaretle
                                    </button>
                                }
                                <button class="btn btn-sm btn-outline-secondary" onclick="toggleNotifications()">
                                    <i class="ri-close-line"></i> Kapat
                                </button>
                            </div>
                        </div>
                        <div class="notification-panel-body">
                            @if (Model.Notifications.Any())
                            {
                                @foreach (var notification in Model.Notifications.Where(i=>i.IsRead==false).Take(10))
                                {
                                    <div class="notification-item @(!notification.IsRead ? "unread" : "")" data-id="@notification.Id">
                                        <div class="notification-content">
                                            <div class="notification-meta">
                                                <div class="notification-type-icon bg-@(GetNotificationColor(notification.Type))-subtle text-@(GetNotificationColor(notification.Type))">
                                                    <i class="@GetNotificationIcon(notification.Type)"></i>
                                                </div>
                                                <small class="text-muted">@notification.CreatedDate.ToString("dd.MM.yyyy HH:mm")</small>
                                                @if (!notification.IsRead)
                                                {
                                                    <span class="badge bg-primary">Yeni</span>
                                                }
                                            </div>
                                            @{
                                                var notificationUrl = GetNotificationUrl(notification.Type);
                                            }
                                            <a href="@notificationUrl" class="notification-title-link" onclick="handleNotificationClick(@notification.Id, '@notificationUrl', event)">
                                                <h6 class="notification-title mb-1" style="color:#2385ba">@notification.Title</h6>
                                            </a>
                                            <p class="notification-message mb-2 text-muted">@notification.Message</p>
                                        </div>
                                        @if (!notification.IsRead)
                                        {
                                            <div class="notification-actions">
                                                <button class="btn btn-sm btn-outline-primary btn-mark-read" onclick="markAsRead(@notification.Id)">
                                                    <i class="ri-check-line"></i> Okundu olarak işaretle
                                                </button>
                                            </div>
                                        }
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="notification-empty">
                                    <div class="avatar-md mx-auto mb-3">
                                        <div class="avatar-title bg-light rounded-circle display-6 text-muted">
                                            <i class="ri-notification-off-line"></i>
                                        </div>
                                    </div>
                                    <h6>Henüz bildiriminiz bulunmuyor</h6>
                                    <p class="text-muted">Yeni bildirimler geldiğinde burada görüntülenecektir.</p>
                                </div>
                            }
                        </div>
                        @if (Model.Notifications.Count() > 10)
                        {
                            <div class="notification-panel-footer">
                                <a href="@Url.Action("Notifications")" class="btn btn-link">
                                    Tüm Bildirimleri Görüntüle (@Model.Notifications.Count())
                                </a>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Stats Row -->
            <div class="row">
                <div class="col-xl-4 col-md-6">
                    <div class="card card-animate">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1">
                                    <p class="text-uppercase fw-medium text-muted mb-0">Toplam Tekliflerim</p>
                                </div>
                                <div class="flex-shrink-0">
                                    <h5 class="text-success fs-14 mb-0">
                                        <i class="ri-arrow-right-up-line fs-13 align-middle"></i>
                                    </h5>
                                </div>
                            </div>
                            <div class="d-flex align-items-end justify-content-between mt-4">
                                <div>
                                    <h4 class="fs-22 fw-semibold ff-secondary mb-4">
                                        <span class="counter-value" data-target="@Model.Stats.MyOffers">@Model.Stats.MyOffers</span>
                                    </h4>
                                    <a href="@Url.Action("Offers")" class="text-decoration-underline">Tüm Teklifler</a>
                                </div>
                                <div class="avatar-sm flex-shrink-0">
                                    <span class="avatar-title bg-success-subtle rounded fs-3">
                                        <i class="bx bx-clipboard text-success"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-4 col-md-6">
                    <div class="card card-animate">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1">
                                    <p class="text-uppercase fw-medium text-muted mb-0">Bekleyen Teklifler</p>
                                </div>
                                <div class="flex-shrink-0">
                                    <h5 class="text-warning fs-14 mb-0">
                                        <i class="ri-arrow-right-up-line fs-13 align-middle"></i>
                                    </h5>
                                </div>
                            </div>
                            <div class="d-flex align-items-end justify-content-between mt-4">
                                <div>
                                    <h4 class="fs-22 fw-semibold ff-secondary mb-4">
                                        <span class="counter-value" data-target="@Model.Stats.PendingOffers">@Model.Stats.PendingOffers</span>
                                    </h4>
                                    <a href="@Url.Action("Offers", new { status = "pending" })" class="text-decoration-underline">Bekleyen Teklifler</a>
                                </div>
                                <div class="avatar-sm flex-shrink-0">
                                    <span class="avatar-title bg-warning-subtle rounded fs-3">
                                        <i class="bx bx-time text-warning"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-4 col-md-6">
                    <div class="card card-animate">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1">
                                    <p class="text-uppercase fw-medium text-muted mb-0">Onaylanan Teklifler</p>
                                </div>
                                <div class="flex-shrink-0">
                                    <h5 class="text-success fs-14 mb-0">
                                        <i class="ri-arrow-right-up-line fs-13 align-middle"></i>
                                    </h5>
                                </div>
                            </div>
                            <div class="d-flex align-items-end justify-content-between mt-4">
                                <div>
                                    <h4 class="fs-22 fw-semibold ff-secondary mb-4">
                                        <span class="counter-value" data-target="@Model.Stats.ApprovedOffers">@Model.Stats.ApprovedOffers</span>
                                    </h4>
                                    <a href="@Url.Action("Offers", new { status = "approved" })" class="text-decoration-underline">Onaylı Teklifler</a>
                                </div>
                                <div class="avatar-sm flex-shrink-0">
                                    <span class="avatar-title bg-success-subtle rounded fs-3">
                                        <i class="bx bx-check-circle text-success"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Available Requests -->
                <div class="col-xl-8">
                    <div class="card">
                        <div class="card-header align-items-center d-flex">
                            <h4 class="card-title mb-0 flex-grow-1">
                                Açık Talepler
                                @if (Model.AvailableRequests.Any())
                                {
                                    <span class="badge bg-info ms-2">@Model.AvailableRequests.Count</span>
                                }
                            </h4>
                            <div class="flex-shrink-0">
                                <a href="@Url.Action("AvailableRequests")" class="btn btn-soft-info btn-sm">
                                    <i class="ri-eye-line align-middle"></i> Teklif Ver
                                </a>
                            </div>
                        </div>

                        <div class="card-body">
                            @if (Model.AvailableRequests.Any())
                            {
                                <div class="table-responsive table-card">
                                    <table class="table table-hover table-centered align-middle table-nowrap mb-0">
                                        <thead>
                                            <tr>
                                                <th>Ürün</th>
                                                <th>Miktar</th>
                                                <th>Şantiye</th>
                                                <th>Talep Tarihi</th>
                                                <th>Teslimat</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var request in Model.AvailableRequests.Take(5))
                                            {
                                                <tr>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <div class="flex-shrink-0 me-2">
                                                                <div class="avatar-xs">
                                                                    <div class="avatar-title bg-light text-primary rounded fs-16">
                                                                        <i class="ri-product-hunt-line"></i>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="flex-grow-1">
                                                                <h6 class="mb-0 text-truncate" style="max-width: 200px;" title="@request.ProductDescription">
                                                                    @request.ProductDescription
                                                                </h6>
                                                                <p class="mb-0 text-muted fs-12">@request.Description</p>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>@request.Quantity</td>
                                                    <td>@request.SiteName</td>
                                                    <td>@request.RequestDate.ToString("dd.MM.yyyy")</td>
                                                    <td>
                                                        <span class="badge bg-info-subtle text-info">
                                                            @switch (request.DeliveryType)
                                                            {
                                                                case DeliveryType.TodayPickup:
                                                                    <text>Bugün Alınacak</text>
                                                                    break;
                                                                case DeliveryType.SameDayDelivery:
                                                                    <text>Gün İçi</text>
                                                                    break;
                                                                case DeliveryType.NextDayDelivery:
                                                                    <text>Yarın</text>
                                                                    break;
                                                                case DeliveryType.BusinessDays1to2:
                                                                    <text>1-2 Gün</text>
                                                                    break;
                                                            }
                                                        </span>
                                                    </td>                                                  
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                            else
                            {
                                <div class="text-center py-4">
                                    <div class="avatar-md mx-auto mb-4">
                                        <div class="avatar-title bg-light rounded-circle display-6 text-muted">
                                            <i class="ri-inbox-line"></i>
                                        </div>
                                    </div>
                                    <h5>Henüz açık talep bulunmuyor</h5>
                                    <p class="text-muted">Yeni talepler geldiğinde burada görüntülenecektir.</p>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <!-- Recent Offers -->
                <div class="col-xl-4">
                    <div class="card">
                        <div class="card-header align-items-center d-flex">
                            <h4 class="card-title mb-0 flex-grow-1">Son Tekliflerim</h4>
                            <div class="flex-shrink-0">
                                <a href="@Url.Action("Offers")" class="btn btn-soft-info btn-sm">
                                    <i class="ri-eye-line align-middle"></i> Tümü
                                </a>
                            </div>
                        </div>

                        <div class="card-body">
                            @if (Model.MyOffers.Any())
                            {
                                <div class="vstack gap-3">
                                    @foreach (var offer in Model.MyOffers.Take(5))
                                    {
                                        <div class="p-3 border border-dashed border-start-0 border-end-0">
                                            <div class="d-flex align-items-center">
                                                <div class="flex-shrink-0 me-3">
                                                    <div class="avatar-sm">
                                                        <div class="avatar-title bg-light rounded fs-3">
                                                            @switch (offer.Status)
                                                            {
                                                                case OfferStatus.Pending:
                                                                    <i class="ri-time-line text-warning"></i>
                                                                    break;
                                                                case OfferStatus.Approved:
                                                                    <i class="ri-check-line text-success"></i>
                                                                    break;
                                                                case OfferStatus.Rejected:
                                                                    <i class="ri-close-line text-danger"></i>
                                                                    break;
                                                            }
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-1 text-truncate" title="@offer.RequestTitle">@offer.RequestTitle</h6>
                                                    <p class="mb-1 text-muted fs-12">@offer.FinalPrice.ToString("C")</p>
                                                    <p class="mb-0 text-muted fs-11">@offer.OfferDate.ToString("dd.MM.yyyy")</p>
                                                </div>
                                                <div class="flex-shrink-0">
                                                    @switch (offer.Status)
                                                    {
                                                        case OfferStatus.Pending:
                                                            <span class="badge bg-warning-subtle text-warning">Bekliyor</span>
                                                            break;
                                                        case OfferStatus.Approved:
                                                            <span class="badge bg-success-subtle text-success">Onaylandı</span>
                                                            break;
                                                        case OfferStatus.Rejected:
                                                            <span class="badge bg-danger-subtle text-danger">Red</span>
                                                            break;
                                                    }
                                                </div>
                                            </div>
                                            <div class="mt-2">
                                                <a href="@Url.Action("OfferDetails", new { id = offer.Id })" class="btn btn-link btn-sm p-0">
                                                    Detayları Gör <i class="ri-arrow-right-line align-middle"></i>
                                                </a>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="text-center py-4">
                                    <div class="avatar-md mx-auto mb-4">
                                        <div class="avatar-title bg-light rounded-circle display-6 text-muted">
                                            <i class="ri-file-list-line"></i>
                                        </div>
                                    </div>
                                    <h6>Henüz teklif vermediniz</h6>
                                    <p class="text-muted fs-12">Açık taleplere teklif verebilirsiniz.</p>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Real-time status indicator -->
<div class="realtime-status" id="realtimeStatus">
    <div class="status-dot"></div>
    <span>Canlı takip aktif</span>
</div>

@section Scripts {
    <script>
         // Counter animation
        // Counter animation
         document.addEventListener('DOMContentLoaded', function() {
             const counters = document.querySelectorAll('.counter-value');

             counters.forEach(counter => {
                 const target = parseInt(counter.getAttribute('data-target'));
                 const start = 0;
                 const duration = 1000;
                 const step = (target - start) / (duration / 16);

                 let current = start;
                 const timer = setInterval(() => {
                     current += step;
                     if (current >= target) {
                         current = target;
                         clearInterval(timer);
                     }
                     counter.textContent = Math.floor(current);
                 }, 16);
             });

             // Show real-time status indicator after page load
             setTimeout(() => {
                 const statusIndicator = document.getElementById('realtimeStatus');
                 if (statusIndicator) {
                     statusIndicator.classList.add('active');
                     setTimeout(() => {
                         statusIndicator.classList.remove('active');
                     }, 3000);
                 }
             }, 2000);

             // **YENİ: Her 30 saniyede bir okunmamış bildirimleri kontrol et**
             checkUnreadNotifications();
             setInterval(checkUnreadNotifications, 30000); // 30 saniye
         });

         // **YENİ: Okunmamış bildirimleri kontrol et ve toast göster**
        async function checkUnreadNotifications() {
            try {
                const response = await fetch('/Supplier/GetNotificationSummary', {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data && result.data.unreadCount > 0) {
                        showNotificationToast(result.data.unreadCount);
                    }
                }
            } catch (error) {
                console.error('Error checking unread notifications:', error);
            }
        }

        // **YENİ: Toast bildirimi göster**
        function showNotificationToast(count) {
            // Eğer Toastify kütüphanesi kullanıyorsanız
            if (typeof Toastify !== 'undefined') {
                Toastify({
                    text: `${count} adet okunmamış bildiriminiz var!`,
                    duration: 5000,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "linear-gradient(to right, #ffc107, #ff9800)",
                    className: "notification-toast",
                    onClick: function() {
                        toggleNotifications();
                    }
                }).showToast();
            }
            // Bootstrap Toast kullanıyorsanız
            else if (typeof bootstrap !== 'undefined') {
                const toastHtml = `
                    <div class="toast align-items-center text-white bg-warning border-0" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="d-flex">
                            <div class="toast-body">
                                <i class="ri-notification-3-line me-2"></i>
                                ${count} adet okunmamış bildiriminiz var!
                            </div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                    </div>
                `;

                let toastContainer = document.getElementById('toastContainer');
                if (!toastContainer) {
                    toastContainer = document.createElement('div');
                    toastContainer.id = 'toastContainer';
                    toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                    toastContainer.style.zIndex = '9999';
                    document.body.appendChild(toastContainer);
                }

                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = toastHtml;
                const toastElement = tempDiv.firstElementChild;
                toastContainer.appendChild(toastElement);

                const toast = new bootstrap.Toast(toastElement);
                toast.show();

                // Toast'a tıklandığında bildirimleri aç
                toastElement.addEventListener('click', function() {
                    toggleNotifications();
                });

                // Toast kapandığında DOM'dan kaldır
                toastElement.addEventListener('hidden.bs.toast', function() {
                    toastElement.remove();
                });
            }
            // Basit bir alternatif (kütüphane yoksa)
            else {
                const toastHtml = `
                    <div class="custom-toast" style="
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: linear-gradient(to right, #ffc107, #ff9800);
                        color: white;
                        padding: 15px 20px;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                        z-index: 9999;
                        cursor: pointer;
                        animation: slideInRight 0.3s ease;
                    ">
                        <i class="ri-notification-3-line me-2"></i>
                        ${count} adet okunmamış bildiriminiz var!
                    </div>
                `;

                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = toastHtml;
                const toastElement = tempDiv.firstElementChild;
                document.body.appendChild(toastElement);

                toastElement.addEventListener('click', function() {
                    toggleNotifications();
                    toastElement.remove();
                });

                setTimeout(() => {
                    toastElement.style.animation = 'slideOutRight 0.3s ease';
                    setTimeout(() => toastElement.remove(), 300);
                }, 5000);
            }
        }


        // Handle notification click - mark as read and navigate
        async function handleNotificationClick(notificationId, url, event) {
            // Prevent the default link behavior temporarily
            event.preventDefault();
            
            // Check if this notification is unread
            const notificationItem = document.querySelector(`[data-id="${notificationId}"]`);
            const isUnread = notificationItem && notificationItem.classList.contains('unread');
            
            if (isUnread) {
                try {
                    // Mark as read first
                    await markAsRead(notificationId);
                    
                    // Wait a moment for the UI to update, then navigate
                    setTimeout(() => {
                        window.location.href = url;
                    }, 300);
                } catch (error) {
                    console.error('Error marking notification as read:', error);
                    // Navigate anyway even if marking as read fails
                    window.location.href = url;
                }
            } else {
                // If already read, navigate immediately
                window.location.href = url;
            }
        }

        // Notification functions
        function toggleNotifications() {
            const panel = document.getElementById('notificationPanel');
            if (panel) {
                if (panel.classList.contains('show')) {
                    panel.classList.remove('show');
                    setTimeout(() => {
                        panel.style.display = 'none';
                    }, 300);
                } else {
                    panel.style.display = 'block';
                    setTimeout(() => {
                        panel.classList.add('show');
                    }, 10);
                }
            }
        }

        // Mark single notification as read
        async function markAsRead(notificationId) {
            console.log('markAsRead called with ID:', notificationId);
            
            try {
                const response = await fetch('/Supplier/MarkNotificationAsRead', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify(notificationId)
                });

                console.log('API response status:', response.status);
                console.log('API response ok:', response.ok);

                if (response.ok) {
                    const result = await response.json();
                    console.log('API response result:', result);
                    
                    if (result.success) {
                        // Update UI
                        const notificationItem = document.querySelector(`[data-id="${notificationId}"]`);
                        if (notificationItem) {
                            notificationItem.classList.remove('unread');
                            const badge = notificationItem.querySelector('.badge');
                            if (badge && badge.textContent === 'Yeni') badge.remove();
                            const actions = notificationItem.querySelector('.notification-actions');
                            if (actions) actions.remove();
                        }

                        // Also update in the recent notifications section
                        const recentNotificationCards = document.querySelectorAll('.col-md-4 .card');
                        recentNotificationCards.forEach(card => {
                            // Check if this card has the same notification by checking onclick attribute
                            const onclickAttr = card.getAttribute('onclick');
                            if (onclickAttr && onclickAttr.includes(notificationId)) {
                                card.classList.remove('border-info');
                                card.classList.add('border-light');
                                const newBadge = card.querySelector('.badge.bg-primary');
                                if (newBadge) newBadge.remove();
                            }
                        });

                        // Update counters
                        updateNotificationCounts();
                        
                        // Check if all notifications are read, if so hide the alert
                        checkAndHideAlertIfAllRead();
                        
                        return true;
                    } else {
                        console.error('API returned success=false:', result);
                        return false;
                    }
                } else {
                    console.error('API response not ok:', response.status, response.statusText);
                    const errorText = await response.text();
                    console.error('Error response text:', errorText);
                    return false;
                }
            } catch (error) {
                console.error('Error marking notification as read:', error);
                return false;
            }
        }

        // Mark all notifications as read
        async function markAllAsRead() {
            try {
                const response = await fetch('/Supplier/MarkAllNotificationsAsRead', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        // Update UI - remove unread styling from all notifications
                        const unreadItems = document.querySelectorAll('.notification-item.unread');
                        unreadItems.forEach(item => {
                            item.classList.remove('unread');
                            const badge = item.querySelector('.badge');
                            if (badge && badge.textContent === 'Yeni') badge.remove();
                            const actions = item.querySelector('.notification-actions');
                            if (actions) actions.remove();
                        });

                        // Update recent notifications cards
                        const recentNotificationCards = document.querySelectorAll('.col-md-4 .card.border-info');
                        recentNotificationCards.forEach(card => {
                            card.classList.remove('border-info');
                            card.classList.add('border-light');
                            const newBadge = card.querySelector('.badge.bg-primary');
                            if (newBadge) newBadge.remove();
                        });

                        // Update counters
                        updateNotificationCounts(0);
                        
                        // Hide the notification alert
                        const alert = document.getElementById('notificationAlert');
                        if (alert) {
                            alert.style.display = 'none';
                        }

                        // Update panel header
                        const headerBadge = document.querySelector('.notification-panel-header .badge');
                        if (headerBadge) headerBadge.remove();

                        const markAllBtn = document.querySelector('button[onclick="markAllAsRead()"]');
                        if (markAllBtn) markAllBtn.style.display = 'none';
                        
                        // Update recent notifications section title
                        const recentNotificationsTitle = document.querySelector('.card-title');
                        if (recentNotificationsTitle && recentNotificationsTitle.textContent.includes('Son Bildirimler')) {
                            const dangerBadge = recentNotificationsTitle.querySelector('.badge.bg-danger');
                            if (dangerBadge) dangerBadge.remove();
                        }
                        
                        // Show success message
                        console.log('Tüm bildirimler okundu olarak işaretlendi.');
                    }
                } else {
                    console.error('Bildirimler işaretlenirken hata oluştu.');
                }
            } catch (error) {
                console.error('Error marking all notifications as read:', error);
            }
        }

        // Check if all notifications are read and hide alert if necessary
        function checkAndHideAlertIfAllRead() {
            const unreadItems = document.querySelectorAll('.notification-item.unread');
            if (unreadItems.length === 0) {
                const alert = document.getElementById('notificationAlert');
                if (alert) {
                    alert.style.display = 'none';
                }
                
                // Hide mark all button
                const markAllBtn = document.querySelector('button[onclick="markAllAsRead()"]');
                if (markAllBtn) markAllBtn.style.display = 'none';
                
                // Update panel header badge
                const headerBadge = document.querySelector('.notification-panel-header .badge');
                if (headerBadge) headerBadge.remove();
            }
        }

        // Update notification count displays
        function updateNotificationCounts(count = null) {
            if (count === null) {
                // Count unread notifications on page
                count = document.querySelectorAll('.notification-item.unread').length;
            }

            const countElements = document.querySelectorAll('.notifications-count');
            countElements.forEach(el => {
                el.textContent = count;
                if (count === 0) {
                    el.style.display = 'none';
                }
            });

            // Update badges
            const badges = document.querySelectorAll('.badge.notifications-count');
            badges.forEach(badge => {
                if (count === 0) {
                    badge.remove();
                }
            });
        }

        // Auto-refresh notifications every 60 seconds
        setInterval(async function() {
            try {
                const response = await fetch('/Supplier/GetNotificationSummary', {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        const unreadCount = result.data.unreadCount;
                        updateNotificationCounts(unreadCount);
                        
                        // Show/hide notification alert based on unread count
                        const alert = document.getElementById('notificationAlert');
                        if (alert) {
                            if (unreadCount > 0) {
                                if (alert.style.display === 'none') {
                                    alert.style.display = 'block';
                                }
                                // Update the count in the alert
                                const countSpan = alert.querySelector('.notifications-count');
                                if (countSpan) countSpan.textContent = unreadCount;
                            } else {
                                alert.style.display = 'none';
                            }
                        }
                        
                        // If there are new unread notifications, refresh the page to show them
                        if (unreadCount > 0) {
                            const currentUnreadInPanel = document.querySelectorAll('.notification-item.unread').length;
                            // Only refresh if the count has changed significantly (new notifications arrived)
                            if (unreadCount > currentUnreadInPanel) {
                                // Refresh the notification panel content
                                await refreshNotificationPanel();
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Error refreshing notification summary:', error);
            }
        }, 60000); // Every 60 seconds
    </script>
    
    <!-- Include notification checker -->
    <script src="~/js/notification-checker.js"></script>
}

@functions {
    private string GetNotificationIcon(NotificationType type)
    {
        return type switch
        {
            NotificationType.RequestSentToSupplier => "ri-send-plane-line",
            NotificationType.NewOffer => "ri-price-tag-3-line",
            NotificationType.OfferApproved => "ri-check-line",
            NotificationType.OfferRejected => "ri-close-line",
            _ => "ri-notification-line"
        };
    }

    private string GetNotificationColor(NotificationType type)
    {
        return type switch
        {
            NotificationType.RequestSentToSupplier => "info",
            NotificationType.NewOffer => "warning",
            NotificationType.OfferApproved => "success",
            NotificationType.OfferRejected => "danger",
            _ => "primary"
        };
    }

    private string GetNotificationUrl(NotificationType type)
    {
        return type switch
        {
            NotificationType.NewOffer => Url.Action("Offers", "Supplier"),
            NotificationType.OfferApproved => Url.Action("Offers", "Supplier"),
            NotificationType.OfferRejected => Url.Action("Offers", "Supplier"),           
            NotificationType.ExcelRequestAssigned => Url.Action("ExcelRequests","Supplier"),
            _ => Url.Action("AvailableRequests", "Supplier")
        };
    }
}