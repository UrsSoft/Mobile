@model List<SantiyeTalepWebUI.Models.DTOs.SupplierDto>
@{
    ViewData["Title"] = "Tedarikçi Yönetimi";
}

<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">

            <!-- start page title -->
            <div class="row">
                <div class="col-12">
                    <div class="page-title-box d-sm-flex align-items-center justify-content-between">
                        <h4 class="mb-sm-0">Tedarikçi Yönetimi</h4>

                        <div class="page-title-right">
                            <ol class="breadcrumb m-0">
                                <li class="breadcrumb-item"><a href="@Url.Action("Dashboard", "Admin")">Dashboard</a></li>
                                <li class="breadcrumb-item active">Tedarikçiler</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
            <!-- end page title -->

            @if (TempData["SuccessMessage"] != null)
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="ri-checkbox-circle-line me-2 align-middle fs-16"></i>
                    @TempData["SuccessMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            }

            @if (TempData["ErrorMessage"] != null)
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="ri-error-warning-line me-2 align-middle fs-16"></i>
                    @TempData["ErrorMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            }

            <div class="row">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-header align-items-center d-flex">
                            <h4 class="card-title mb-0 flex-grow-1">
                                <i class="ri-user-line text-primary me-2"></i>
                                Tedarikçi Listesi
                            </h4>
                            <div class="flex-shrink-0">
                                <a href="@Url.Action("CreateSupplier", "Admin")" class="btn btn-primary">
                                    <i class="ri-add-line align-bottom me-1"></i> Yeni Tedarikçi Ekle
                                </a>
                            </div>
                        </div><!-- end card header -->

                        <div class="card-body">
                            <!-- Search and Filter Bar -->
                            <div class="row g-3 mb-3">
                                <div class="col-md-4">
                                    <div class="search-box">
                                        <input type="text" class="form-control search" placeholder="Þirket adý, kiþi veya telefon ile ara..." id="searchInput">
                                        <i class="ri-search-line search-icon"></i>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-select" id="statusFilter">
                                        <option value="">Tüm Durumlar</option>
                                        <option value="active">Aktif</option>
                                        <option value="inactive">Pasif</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <button type="button" class="btn btn-soft-secondary w-100" onclick="resetFilters()">
                                        <i class="ri-refresh-line align-bottom me-1"></i> Sýfýrla
                                    </button>
                                </div>
                                <div class="col-md-3 text-end">
                                    <span class="text-muted">Toplam: <strong id="totalCount">@Model?.Count ?? 0</strong> tedarikçi</span>
                                </div>
                            </div>

                            <div class="table-responsive">
                                <table class="table table-nowrap table-hover align-middle mb-0" id="suppliersTable">
                                    <thead class="table-light">
                                        <tr class="text-center">                                            
                                            <th scope="col">Þirket Bilgileri</th>
                                            <th scope="col">Ýletiþim Kiþisi</th>
                                            <th scope="col">E-posta</th>
                                            <th scope="col">Telefon</th>
                                            <th scope="col">Durum</th>
                                            <th scope="col">Kayýt Tarihi</th>
                                            <th scope="col" class="text-center" style="width: 120px;">Ýþlemler</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @if (Model != null && Model.Any())
                                        {
                                            @foreach (var supplier in Model)
                                            {
                                                <tr data-status="@(supplier.User?.IsActive == true ? "active" : "inactive")" class="text-center">                                                  
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <div class="flex-shrink-0 me-2">
                                                                <div class="avatar-sm">
                                                                    <div class="avatar-title bg-primary-subtle text-primary rounded-circle fs-18">
                                                                        <i class="ri-building-2-line"></i>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="flex-grow-1">
                                                                <h6 class="mb-1">@supplier.CompanyName</h6>
                                                                <p class="mb-0 text-muted fs-12">
                                                                    <i class="ri-bank-card-line me-1"></i>@supplier.TaxNumber
                                                                </p>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <div class="flex-grow-1">
                                                                <h6 class="mb-1">@supplier.User?.FullName</h6>                                                              
                                                            </div>
                                                           
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <a href="mailto:@supplier.User?.Email" class="text-decoration-none">
                                                            <i class="ri-mail-line text-muted me-1"></i>@supplier.User?.Email
                                                        </a>
                                                    </td>
                                                    <td>
                                                        <a href="tel:@supplier.User?.Phone" class="text-decoration-none">
                                                            <i class="ri-phone-line text-muted me-1"></i>@supplier.User?.Phone
                                                        </a>
                                                    </td>
                                                    <td>
                                                        @if (supplier.User?.IsActive == true)
                                                        {
                                                            <span class="badge bg-success-subtle text-success">
                                                                <i class="ri-checkbox-circle-line me-1"></i>Aktif
                                                            </span>
                                                        }
                                                        else
                                                        {
                                                            <span class="badge bg-danger-subtle text-danger">
                                                                <i class="ri-close-circle-line me-1"></i>Pasif
                                                            </span>
                                                        }
                                                    </td>
                                                    <td>
                                                        <small class="text-muted">
                                                            <i class="ri-calendar-line me-1"></i>
                                                            @supplier.CreatedDate.ToString("dd.MM.yyyy")
                                                        </small>
                                                    </td>
                                                    <td>
                                                        <div class="text-center">
                                                            <button onclick="editSupplier(@supplier.Id)" class="btn btn-sm btn-soft-info">
                                                                <i class="ri-pencil-fill align-bottom"></i> Düzenle
                                                            </button>
                                                            <button onclick="deleteSupplier(@supplier.Id, '@(string.IsNullOrWhiteSpace(supplier.FullName) ? "Bu çalýþan" : supplier.FullName)')" class="btn btn-sm btn-soft-danger">
                                                                <i class="ri-delete-bin-fill align-bottom"></i> Sil
                                                            </button>
                                                        </div>                                                       
                                                    </td>
                                                </tr>
                                            }
                                        }
                                        else
                                        {
                                            <tr>
                                                <td colspan="8" class="text-center py-5">
                                                    <div class="d-flex flex-column align-items-center">
                                                        <i class="ri-user-add-line display-3 text-muted mb-3"></i>
                                                        <h5 class="text-muted mb-2">Henüz tedarikçi bulunmuyor</h5>
                                                        <p class="text-muted mb-3">Yeni tedarikçi eklemek için butonu kullanabilirsiniz.</p>
                                                        <a href="@Url.Action("CreateSupplier", "Admin")" class="btn btn-primary">
                                                            <i class="ri-add-line me-1"></i> Ýlk Tedarikçiyi Ekle
                                                        </a>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div><!-- end card body -->
                    </div><!-- end card -->
                </div><!-- end col -->
            </div><!-- end row -->

        </div>
        <!-- container-fluid -->
    </div>
    <!-- End Page-content -->
</div>

<!-- Supplier Detail Modal -->
<div class="modal fade" id="supplierDetailModal" tabindex="-1" aria-labelledby="supplierDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="supplierDetailModalLabel">
                    <i class="ri-building-2-line text-primary me-2"></i>Tedarikçi Detaylarý
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="supplierDetailContent">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Yükleniyor...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="ri-close-line me-1"></i>Kapat
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        function viewSupplier(id) {
            $('#supplierDetailModal').modal('show');
            
            $.ajax({
                url: '@Url.Action("GetSupplierDetails", "Admin")',
                type: 'GET',
                data: { id: id },
                success: function (response) {
                    if (response.success) {
                        $('#supplierDetailContent').html(response.html);
                    } else {
                        $('#supplierDetailContent').html(
                            '<div class="alert alert-danger"><i class="ri-error-warning-line me-2"></i>' + 
                            response.message + '</div>'
                        );
                    }
                },
                error: function () {
                    $('#supplierDetailContent').html(
                        '<div class="alert alert-danger"><i class="ri-error-warning-line me-2"></i>' +
                        'Tedarikçi detaylarý yüklenirken bir hata oluþtu.</div>'
                    );
                }
            });
        }

        function editSupplier(id) {
            window.location.href = '@Url.Action("EditSupplier", "Admin")?id=' + id;
        }

        function deleteSupplier(id) {
            Swal.fire({
                title: 'Tedarikçiyi Sil',
                text: "Bu tedarikçiyi silmek istediðinizden emin misiniz? Bu iþlem geri alýnamaz!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#f06548',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '<i class="ri-delete-bin-line me-1"></i> Evet, Sil',
                cancelButtonText: '<i class="ri-close-line me-1"></i> Ýptal'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '@Url.Action("DeleteSupplier", "Admin")',
                        type: 'POST',
                        data: { id: id },
                        headers: {
                            'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                        },
                        success: function (response) {
                            if (response.success) {
                                Swal.fire({
                                    title: 'Baþarýlý!',
                                    text: response.message,
                                    icon: 'success',
                                    confirmButtonColor: '#0ab39c'
                                }).then(() => {
                                    window.location.reload();
                                });
                            } else {
                                Swal.fire({
                                    title: 'Hata!',
                                    text: response.message,
                                    icon: 'error',
                                    confirmButtonColor: '#f06548'
                                });
                            }
                        },
                        error: function () {
                            Swal.fire({
                                title: 'Hata!',
                                text: 'Tedarikçi silinirken bir hata oluþtu.',
                                icon: 'error',
                                confirmButtonColor: '#f06548'
                            });
                        }
                    });
                }
            });
        }

        // Search functionality
        $(document).ready(function() {
            $('#searchInput').on('keyup', function() {
                filterTable();
            });

            $('#statusFilter').on('change', function() {
                filterTable();
            });

            function filterTable() {
                var searchText = $('#searchInput').val().toLowerCase();
                var statusFilter = $('#statusFilter').val();
                var visibleCount = 0;

                $('#suppliersTable tbody tr').each(function() {
                    var row = $(this);
                    var text = row.text().toLowerCase();
                    var status = row.data('status');
                    
                    var matchSearch = searchText === '' || text.indexOf(searchText) > -1;
                    var matchStatus = statusFilter === '' || status === statusFilter;

                    if (matchSearch && matchStatus) {
                        row.show();
                        visibleCount++;
                    } else {
                        row.hide();
                    }
                });

                $('#totalCount').text(visibleCount);
            }

            function resetFilters() {
                $('#searchInput').val('');
                $('#statusFilter').val('');
                filterTable();
            }

            // Make resetFilters available globally
            window.resetFilters = resetFilters;
        });
    </script>
}