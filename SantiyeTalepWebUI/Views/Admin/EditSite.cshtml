@model UpdateSiteDto
@{
    ViewData["Title"] = "Þantiye Düzenle";
    var brands = ViewBag.Brands as List<BrandDto> ?? new List<BrandDto>();
    var availableEmployees = ViewBag.AvailableEmployees as List<EmployeeDto> ?? new List<EmployeeDto>();
}

<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">

            <!-- start page title -->
            <div class="row">
                <div class="col-12">
                    <div class="page-title-box d-sm-flex align-items-center justify-content-between">
                        <h4 class="mb-sm-0">Þantiye Düzenle</h4>

                        <div class="page-title-right">
                            <ol class="breadcrumb m-0">
                                <li class="breadcrumb-item"><a href="@Url.Action("Dashboard", "Admin")">Dashboard</a></li>
                                <li class="breadcrumb-item"><a href="@Url.Action("Sites", "Admin")">Þantiyeler</a></li>
                                <li class="breadcrumb-item active">Þantiye Düzenle</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
            <!-- end page title -->

            <div class="row justify-content-center">
                <div class="col-xxl-9">
                    <div class="card">
                        <div class="card-header align-items-center d-flex">
                            <h4 class="card-title mb-0 flex-grow-1">
                                <i class="ri-edit-2-line align-middle me-1 text-muted"></i>
                                Þantiye Bilgilerini Düzenle
                            </h4>
                            <div class="flex-shrink-0">
                                <div class="form-check form-switch form-switch-lg">
                                    <input class="form-check-input" type="checkbox" role="switch" 
                                           id="isActiveSwitch" asp-for="IsActive">
                                    <label class="form-check-label fw-medium text-muted" for="isActiveSwitch">
                                        <span id="statusText">@(Model.IsActive ? "Aktif" : "Pasif")</span>
                                    </label>
                                </div>
                            </div>
                        </div><!-- end card header -->

                        <div class="card-body">
                            <form asp-action="EditSite" method="post" class="needs-validation" novalidate>
                                @Html.AntiForgeryToken()
                                <input asp-for="Id" type="hidden" />
                                <input asp-for="IsActive" type="hidden" id="isActiveHidden" />

                                <div class="row">
                                    <div class="col-lg-12">
                                        <div class="mb-3">
                                            <label asp-for="Name" class="form-label">Þantiye Adý <span class="text-danger">*</span></label>
                                            <input asp-for="Name" class="form-control" placeholder="Þantiye adýný giriniz" />
                                            <span asp-validation-for="Name" class="text-danger"></span>
                                            <div class="form-text">Þantiyenin kolayca tanýnabilir bir adýný girin</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-lg-12">
                                        <div class="mb-3">
                                            <label asp-for="Address" class="form-label">Adres <span class="text-danger">*</span></label>
                                            <textarea asp-for="Address" class="form-control" rows="3" placeholder="Þantiyenin tam adresini giriniz"></textarea>
                                            <span asp-validation-for="Address" class="text-danger"></span>
                                            <div class="form-text">Þantiyenin detaylý adres bilgilerini girin</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-lg-12">
                                        <div class="mb-3">
                                            <label asp-for="Description" class="form-label">Açýklama</label>
                                            <textarea asp-for="Description" class="form-control" rows="4" placeholder="Þantiye hakkýnda ek bilgiler giriniz (isteðe baðlý)"></textarea>
                                            <span asp-validation-for="Description" class="text-danger"></span>
                                            <div class="form-text">Þantiye hakkýnda ek açýklamalar yazabilirsiniz (isteðe baðlý)</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Brand Selection Section -->
                                <div class="row">
                                    <div class="col-lg-12">
                                        <div class="mb-4">
                                            <label class="form-label">Þantiye Markalarý <span class="text-danger">*</span></label>
                                            <span asp-validation-for="BrandIds" class="text-danger d-block"></span>
                                            <div class="form-text mb-3">Bu þantiyede kullanýlacak markalarý seçiniz. En az bir marka seçilmelidir.</div>
                                            
                                            <div class="card border">
                                                <div class="card-header bg-light">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <h6 class="mb-0">
                                                            <i class="ri-price-tag-line me-2"></i>Marka Seçimi
                                                        </h6>
                                                        <div>
                                                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllBrands()">
                                                                <i class="ri-check-double-line me-1"></i>Tümünü Seç
                                                            </button>
                                                            <button type="button" class="btn btn-sm btn-outline-secondary ms-1" onclick="clearAllBrands()">
                                                                <i class="ri-close-line me-1"></i>Temizle
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="card-body">
                                                    @if (brands.Any())
                                                    {
                                                        <div class="row g-3">
                                                            @foreach (var brand in brands)
                                                            {
                                                                <div class="col-md-4 col-sm-6">
                                                                    <div class="form-check form-check-custom">
                                                                        <input class="form-check-input brand-checkbox" type="checkbox" 
                                                                               name="BrandIds" value="@brand.Id" id="brand_@brand.Id"
                                                                               @(Model.BrandIds != null && Model.BrandIds.Contains(brand.Id) ? "checked" : "") />
                                                                        <label class="form-check-label d-flex align-items-center" for="brand_@brand.Id">
                                                                            <div class="flex-grow-1">
                                                                                <div class="fw-medium">@brand.Name</div>          
                                                                            </div>
                                                                        </label>
                                                                    </div>
                                                                </div>
                                                            }
                                                        </div>
                                                        
                                                        <div class="mt-3">
                                                            <div class="alert alert-info d-none" id="brandSelectionInfo">
                                                                <i class="ri-information-line me-2"></i>
                                                                <span id="selectedBrandCount">0</span> marka seçildi.
                                                            </div>
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        <div class="text-center py-3">
                                                            <i class="ri-error-warning-line fs-24 text-warning mb-2"></i>
                                                            <p class="text-muted mb-0">Henüz sistem marka bulunamadý.</p>
                                                            <small class="text-muted">Lütfen önce sistem yöneticisi ile iletiþime geçin.</small>
                                                        </div>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                

                                <!-- Preview Card -->
                                <div class="row">
                                    <div class="col-lg-12">
                                        <div class="card bg-light border-dashed">
                                            <div class="card-header">
                                                <h6 class="card-title mb-0">
                                                    <i class="ri-eye-line me-2"></i>Güncel Önizleme
                                                </h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="row g-3">
                                                    <div class="col-md-6">
                                                        <div class="d-flex align-items-center">
                                                            <i class="ri-building-2-line text-primary me-2 fs-16"></i>
                                                            <div>
                                                                <h6 class="mb-0" id="previewName">@Model.Name</h6>
                                                                <small class="text-muted">Þantiye</small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="d-flex align-items-center">
                                                            <i class="ri-toggle-line me-2 fs-16" id="previewStatusIcon"></i>
                                                            <div>
                                                                <span class="fw-medium" id="previewStatus">@(Model.IsActive ? "Aktif" : "Pasif")</span>
                                                                <div><small class="text-muted">Durum</small></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-12">
                                                        <div class="d-flex align-items-center">
                                                            <i class="ri-map-pin-line text-success me-2 fs-16"></i>
                                                            <div>
                                                                <p class="mb-0 text-muted" id="previewAddress">@Model.Address</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-12" id="previewDescriptionContainer" style="@(string.IsNullOrEmpty(Model.Description) ? "display: none;" : "")">
                                                        <div class="d-flex align-items-start">
                                                            <i class="ri-information-line text-info me-2 fs-16 mt-1"></i>
                                                            <div>
                                                                <p class="mb-0 text-muted" id="previewDescription">@Model.Description</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-12" id="previewBrandsContainer">
                                                        <div class="d-flex align-items-start">
                                                            <i class="ri-price-tag-line text-warning me-2 fs-16 mt-1"></i>
                                                            <div class="flex-grow-1">
                                                                <h6 class="mb-1">Seçili Markalar</h6>
                                                                <div id="previewBrands" class="d-flex flex-wrap gap-1">
                                                                    <!-- Brands will be populated by JavaScript -->
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-12" id="previewEmployeesContainer">
                                                        <div class="d-flex align-items-start">
                                                            <i class="ri-team-line text-success me-2 fs-16 mt-1"></i>
                                                            <div class="flex-grow-1">
                                                                <h6 class="mb-1">Seçili Çalýþanlar</h6>
                                                                <div id="previewEmployees" class="d-flex flex-wrap gap-1">
                                                                    <!-- Employees will be populated by JavaScript -->
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-lg-12">
                                        <div class="hstack gap-2 justify-content-end">
                                            <a href="@Url.Action("Sites", "Admin")" class="btn btn-light">
                                                <i class="ri-arrow-left-line align-bottom me-1"></i> Geri Dön
                                            </a>
                                            <button type="button" class="btn btn-ghost-secondary" onclick="resetForm()">
                                                <i class="ri-refresh-line align-bottom me-1"></i> Deðiþiklikleri Geri Al
                                            </button>
                                            <button type="submit" class="btn btn-success">
                                                <i class="ri-save-line align-bottom me-1"></i> Deðiþiklikleri Kaydet
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div><!-- end card body -->
                    </div><!-- end card -->
                </div><!-- end col -->
            </div><!-- end row -->

            <!-- Site Information Card -->
            <div class="row justify-content-center">
                <div class="col-xxl-9">
                    <div class="card bg-primary-subtle border-0">
                        <div class="card-body">
                            <div class="d-flex align-items-start">
                                <div class="flex-shrink-0">
                                    <i class="ri-information-line fs-24 text-primary"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="text-primary mb-2">Þantiye Düzenleme Notlarý</h6>
                                    <ul class="mb-0 text-muted">
                                        <li>Þantiye adýný deðiþtirmek mevcut talepleri etkilemez</li>
                                        <li>Adres deðiþikliði tüm çalýþanlara bildirilir</li>
                                        <li>Marka deðiþiklikleri yeni taleplerde geçerli olur</li>
                                        <li><strong>Çalýþan deðiþiklikleri</strong> anýnda aktif olur</li>
                                        <li><strong>Þantiyeyi pasif yapmak</strong> yeni talep oluþturulmasýný engeller</li>
                                        <li>Pasif þantiyedeki mevcut talepler devam eder ancak yeni talepler alýnmaz</li>
                                        <li>Deðiþiklikler anýnda aktif olur ve sistem genelinde güncellenir</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <!-- container-fluid -->
    </div>
    <!-- End Page-content -->

    <footer class="footer">
        <div class="container-fluid">
            <div class="row">
                <div class="col-sm-6">
                    <script>document.write(new Date().getFullYear())</script> © Þantiye Talep Yönetim Sistemi.
                </div>
                <div class="col-sm-6">
                    <div class="text-sm-end d-none d-sm-block">
                        Velzon Template ile geliþtirilmiþtir.
                    </div>
                </div>
            </div>
        </div>
    </footer>
</div>

@section Scripts {
    <script>
        // Store original values for reset functionality
        const originalValues = {
            name: '@Html.Raw(Model.Name)',
            address: '@Html.Raw(Model.Address.Replace("\r\n", "\\n").Replace("\n", "\\n"))',
            description: '@Html.Raw(Model.Description?.Replace("\r\n", "\\n").Replace("\n", "\\n") ?? "")',
            isActive: @Model.IsActive.ToString().ToLower(),
            brandIds: [@Html.Raw(string.Join(",", Model.BrandIds ?? new List<int>()))],
            employeeIds: [@Html.Raw(string.Join(",", Model.EmployeeIds ?? new List<int>()))]
        };

        // Form change tracking
        let formChanged = false;

        // Form validation
        (function() {
            'use strict';
            window.addEventListener('load', function() {
                var forms = document.getElementsByClassName('needs-validation');
                var validation = Array.prototype.filter.call(forms, function(form) {
                    form.addEventListener('submit', function(event) {
                        // Check if at least one brand is selected
                        const selectedBrands = document.querySelectorAll('.brand-checkbox:checked');
                        
                        if (selectedBrands.length === 0) {
                            event.preventDefault();
                            event.stopPropagation();
                            
                            // Show brand validation error
                            if (!document.querySelector('.brand-validation-error')) {
                                const errorDiv = document.createElement('div');
                                errorDiv.className = 'text-danger brand-validation-error mt-1';
                                errorDiv.textContent = 'En az bir marka seçilmelidir.';
                                document.querySelector('.card-body').appendChild(errorDiv);
                            }
                        } else {
                            // Remove brand validation error if exists
                            const existingError = document.querySelector('.brand-validation-error');
                            if (existingError) {
                                existingError.remove();
                            }
                        }
                        
                        if (form.checkValidity() === false) {
                            event.preventDefault();
                            event.stopPropagation();
                        }
                        form.classList.add('was-validated');
                    }, false);
                });
            }, false);
        })();

        // Status toggle functionality
        document.getElementById('isActiveSwitch').addEventListener('change', function() {
            const isActive = this.checked;
            document.getElementById('isActiveHidden').value = isActive;
            document.getElementById('statusText').textContent = isActive ? 'Aktif' : 'Pasif';
            updateStatusPreview();
            formChanged = true;
        });

        function updateStatusPreview() {
            const isActive = document.getElementById('isActiveSwitch').checked;
            const statusElement = document.getElementById('previewStatus');
            const iconElement = document.getElementById('previewStatusIcon');
            
            if (isActive) {
                statusElement.textContent = 'Aktif';
                iconElement.className = 'ri-toggle-line me-2 fs-16 text-success';
            } else {
                statusElement.textContent = 'Pasif';
                iconElement.className = 'ri-toggle-line me-2 fs-16 text-danger';
            }
        }

        // Brand selection functions
        function selectAllBrands() {
            document.querySelectorAll('.brand-checkbox').forEach(function(checkbox) {
                checkbox.checked = true;
            });
            updateBrandPreview();
            updateBrandCount();
            formChanged = true;
        }

        function clearAllBrands() {
            document.querySelectorAll('.brand-checkbox').forEach(function(checkbox) {
                checkbox.checked = false;
            });
            updateBrandPreview();
            updateBrandCount();
            formChanged = true;
        }

        function updateBrandCount() {
            const selectedCount = document.querySelectorAll('.brand-checkbox:checked').length;
            const countElement = document.getElementById('selectedBrandCount');
            const infoElement = document.getElementById('brandSelectionInfo');
            
            // Check if elements exist before accessing their properties
            if (countElement && infoElement) {
                if (selectedCount > 0) {
                    countElement.textContent = selectedCount;
                    infoElement.classList.remove('d-none');
                } else {
                    infoElement.classList.add('d-none');
                }
            }
        }

        function updateBrandPreview() {
            const selectedBrands = document.querySelectorAll('.brand-checkbox:checked');
            const previewContainer = document.getElementById('previewBrands');
            
            if (selectedBrands.length === 0) {
                previewContainer.innerHTML = '<span class="badge bg-secondary">Henüz marka seçilmedi</span>';
            } else {
                let brandsHtml = '';
                selectedBrands.forEach(function(checkbox) {
                    const label = document.querySelector('label[for="' + checkbox.id + '"] .fw-medium');
                    const brandName = label ? label.textContent : checkbox.value;
                    brandsHtml += `<span class="badge bg-primary me-1 mb-1">${brandName}</span>`;
                });
                previewContainer.innerHTML = brandsHtml;
            }
        }

        // Employee selection functions
        function selectAllEmployees() {
            document.querySelectorAll('.employee-checkbox').forEach(function(checkbox) {
                checkbox.checked = true;
            });
            updateEmployeePreview();
            updateEmployeeCount();
            formChanged = true;
        }

        function clearAllEmployees() {
            document.querySelectorAll('.employee-checkbox').forEach(function(checkbox) {
                checkbox.checked = false;
            });
            updateEmployeePreview();
            updateEmployeeCount();
            formChanged = true;
        }

        function updateEmployeeCount() {
            const selectedCount = document.querySelectorAll('.employee-checkbox:checked').length;
            const countElement = document.getElementById('selectedEmployeeCount');
            const infoElement = document.getElementById('employeeSelectionInfo');
            
            // Check if elements exist before accessing their properties
            if (countElement && infoElement) {
                if (selectedCount > 0) {
                    countElement.textContent = selectedCount;
                    infoElement.classList.remove('d-none');
                } else {
                    infoElement.classList.add('d-none');
                }
            }
        }

        function updateEmployeePreview() {
            const selectedEmployees = document.querySelectorAll('.employee-checkbox:checked');
            const previewContainer = document.getElementById('previewEmployees');
            
            if (selectedEmployees.length === 0) {
                previewContainer.innerHTML = '<span class="badge bg-light text-muted">Henüz çalýþan seçilmedi</span>';
            } else {
                let employeesHtml = '';
                selectedEmployees.forEach(function(checkbox) {
                    const label = document.querySelector('label[for="' + checkbox.id + '"] .fw-medium');
                    const employeeName = label ? label.textContent : checkbox.value;
                    employeesHtml += `<span class="badge bg-success me-1 mb-1">${employeeName}</span>`;
                });
                previewContainer.innerHTML = employeesHtml;
            }
        }

        // Real-time preview
        function updatePreview() {
            const name = document.getElementById('Name').value || 'Þantiye Adý';
            const address = document.getElementById('Address').value || 'Adres bilgisi';
            const description = document.getElementById('Description').value;

            document.getElementById('previewName').textContent = name;
            document.getElementById('previewAddress').textContent = address;
            
            const descContainer = document.getElementById('previewDescriptionContainer');
            const descElement = document.getElementById('previewDescription');
            
            if (description.trim()) {
                descElement.textContent = description;
                descContainer.style.display = 'block';
            } else {
                descContainer.style.display = 'none';
            }
        }

        // Reset form to original values
        function resetForm() {
            if (confirm('Tüm deðiþiklikleri geri almak istediðinizden emin misiniz? Bu iþlem kaydedilmemiþ tüm deðiþiklikleri siler.')) {
                // Reset form fields to original values
                document.getElementById('Name').value = originalValues.name;
                document.getElementById('Address').value = originalValues.address.replace(/\\n/g, '\n');
                document.getElementById('Description').value = originalValues.description.replace(/\\n/g, '\n');
                document.getElementById('isActiveSwitch').checked = originalValues.isActive;
                document.getElementById('isActiveHidden').value = originalValues.isActive;
                document.getElementById('statusText').textContent = originalValues.isActive ? 'Aktif' : 'Pasif';
                
                // Reset brand selections
                document.querySelectorAll('.brand-checkbox').forEach(function(checkbox) {
                    checkbox.checked = originalValues.brandIds.includes(parseInt(checkbox.value));
                });
                
                // Reset employee selections
                document.querySelectorAll('.employee-checkbox').forEach(function(checkbox) {
                    checkbox.checked = originalValues.employeeIds.includes(parseInt(checkbox.value));
                });
                
                // Remove validation classes and errors
                document.querySelector('form').classList.remove('was-validated');
                const existingError = document.querySelector('.brand-validation-error');
                if (existingError) {
                    existingError.remove();
                }
                
                // Update previews
                updatePreview();
                updateBrandPreview();
                updateBrandCount();
                updateEmployeePreview();
                updateEmployeeCount();
                updateStatusPreview();
                
                // Reset form change tracking
                formChanged = false;
            }
        }

        // Event listeners for real-time preview
        document.addEventListener('DOMContentLoaded', function() {
            const nameInput = document.getElementById('Name');
            const addressInput = document.getElementById('Address');
            const descriptionInput = document.getElementById('Description');

            // Input event listeners with form change tracking
            nameInput.addEventListener('input', function() {
                updatePreview();
                formChanged = true;
            });
            
            addressInput.addEventListener('input', function() {
                updatePreview();
                formChanged = true;
            });
            
            descriptionInput.addEventListener('input', function() {
                updatePreview();
                formChanged = true;
            });

            // Brand checkbox event listeners
            document.querySelectorAll('.brand-checkbox').forEach(function(checkbox) {
                checkbox.addEventListener('change', function() {
                    updateBrandPreview();
                    updateBrandCount();
                    formChanged = true;
                    
                    // Remove validation error when user selects a brand
                    const existingError = document.querySelector('.brand-validation-error');
                    if (existingError && document.querySelectorAll('.brand-checkbox:checked').length > 0) {
                        existingError.remove();
                    }
                });
            });

            // Employee checkbox event listeners
            document.querySelectorAll('.employee-checkbox').forEach(function(checkbox) {
                checkbox.addEventListener('change', function() {
                    updateEmployeePreview();
                    updateEmployeeCount();
                    formChanged = true;
                });
            });

            // Character counter for description
            const maxLength = 500;
            const counter = document.createElement('div');
            counter.className = 'form-text text-end';
            counter.id = 'descriptionCounter';
            descriptionInput.parentNode.appendChild(counter);

            function updateCounter() {
                const length = descriptionInput.value.length;
                counter.textContent = `${length}/${maxLength} karakter`;
                counter.className = length > maxLength * 0.9 ? 
                    'form-text text-end text-warning' : 
                    'form-text text-end text-muted';
            }

            descriptionInput.addEventListener('input', function() {
                if (this.value.length > maxLength) {
                    this.value = this.value.substring(0, maxLength);
                }
                updateCounter();
                updatePreview();
                formChanged = true;
            });

            updateCounter();
            updatePreview();
            updateBrandPreview();
            updateBrandCount();
            updateEmployeePreview();
            updateEmployeeCount();
            updateStatusPreview();
        });

        // Form submit handler
        document.querySelector('form').addEventListener('submit', function() {
            formChanged = false; // Don't warn when form is being submitted
        });
    </script>
}