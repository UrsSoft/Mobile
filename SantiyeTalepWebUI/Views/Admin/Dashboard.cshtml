@using SantiyeTalepWebUI.Models;
@using SantiyeTalepWebUI.Models.DTOs;
@model AdminDashboardViewModel
@{
    ViewData["Title"] = "Admin Dashboard";
    Layout = "~/Views/Shared/_Layout.cshtml";
}


<!-- Add notification checker styles -->
@section Styles {
    <link href="~/css/notification-checker.css" rel="stylesheet" />
    <style>
        /* Notification Panel Styles */
        .notification-panel {
            display: none;
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
            overflow: hidden;
            transition: all 0.3s ease;
        }

            .notification-panel.show {
                display: block;
                animation: slideDown 0.3s ease;
            }

        @@keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .notification-panel-header {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .notification-panel-body {
            max-height: 400px;
            overflow-y: auto;
        }

        .notification-item {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #f8f9fa;
            transition: background-color 0.2s ease;
            cursor: pointer;
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
        }

            .notification-item:hover {
                background-color: #f8f9fa;
            }

            .notification-item:last-child {
                border-bottom: none;
            }

            .notification-item.unread {
                border-left: 4px solid #ffc107;
            }

                .notification-item.unread:hover {
                    background-color: #ffeaa7;
                }

        .notification-content {
            flex-grow: 1;
        }

        .notification-meta {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .notification-type-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .notification-panel-footer {
            padding: 1rem 1.5rem;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            text-align: center;
        }

        .notification-empty {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
        }

        .notification-title-link {
            color: #2385ba;
            text-decoration: none;
        }

            .notification-title-link:hover {
                color: #1d6fa3;
                text-decoration: underline;
            }

        /* Product Search Modal Styles */
        .product-search-results {
            max-height: 500px;
            overflow-y: auto;
        }

        .product-search-loading {
            text-align: center;
            padding: 3rem;
        }

        .product-search-error {
            text-align: center;
            padding: 2rem;
            color: #dc3545;
        }

        .product-search-empty {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
        }

        .product-table {
            margin-bottom: 0;
        }

            .product-table th {
                background-color: #f8f9fa;
                font-weight: 600;
                border-bottom: 2px solid #dee2e6;
            }

            .product-table td {
                vertical-align: middle;
            }

        .product-code {
            font-weight: 600;
            color: #556ee6;
        }

        .product-price {
            font-weight: 600;
        }
    </style>
}

<div class="main-content" data-enable-notifications="true">
    <div class="page-content">
        <div class="container-fluid">

            <!-- start page title -->
            <div class="row">
                <div class="col-12">
                    <div class="page-title-box d-sm-flex align-items-center justify-content-between">
                        <h4 class="mb-sm-0">Şantiye Talep Yönetim Sistemi</h4>

                        <div class="page-title-right">
                            <ol class="breadcrumb m-0">
                                <li class="breadcrumb-item"><a href="javascript: void(0);">Ana Sayfa</a></li>
                                <li class="breadcrumb-item active">Dashboard</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
            <!-- end page title -->
            <!-- Notification Alert for New Requests -->
            @{
                var hasUnreadNotifications = Model.NotificationSummary != null && Model.NotificationSummary.UnreadCount > 0;
            }

            @if (hasUnreadNotifications)
            {
                <div class="row mb-4" id="notificationAlertRow">
                    <div class="col-12">
                        <div class="alert alert-info alert-dismissible fade show" role="alert" id="notificationAlert">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0 me-3">
                                    <i class="ri-notification-3-line fs-24 text-info"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="alert-heading mb-1">Yeni Bildirimleriniz Var!</h6>
                                    <p class="mb-0">
                                        <span class="notifications-count">@Model.NotificationSummary.UnreadCount</span> adet okunmamış bildiriminiz bulunuyor.
                                        <a href="javascript:void(0)" onclick="toggleNotificationPanel()" class="alert-link fw-semibold">Bildirimleri görüntülemek için tıklayın</a>.
                                    </p>
                                </div>
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notification Panel (Initially Hidden) -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="notification-panel" id="notificationPanel" style="display: none;">
                            <div class="notification-panel-header">
                                <div class="d-flex align-items-center flex-grow-1">
                                    <i class="ri-notification-3-line fs-20 text-primary me-2"></i>
                                    <h5 class="mb-0">Bildirimlerim</h5>
                                    <span class="badge bg-danger ms-2 notifications-count">@Model.NotificationSummary.UnreadCount</span>
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-primary" onclick="markAllAsReadDashboard()">
                                        <i class="ri-check-double-line"></i> Tümünü Okundu Olarak İşaretle
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="toggleNotificationPanel()">
                                        <i class="ri-close-line"></i> Kapat
                                    </button>
                                </div>
                            </div>
                            <div class="notification-panel-body">
                                @{
                                    var unreadNotifications = Model.Notifications?.Where(n => !n.IsRead).Take(10).ToList() ?? new List<NotificationDto>();
                                }

                                @foreach (var notification in unreadNotifications)
                                {
                                    <div class="notification-item unread" data-id="@notification.Id">
                                        <div class="notification-content">
                                            <div class="notification-meta">
                                                <div class="notification-type-icon bg-@(GetNotificationColor(notification.Type))-subtle text-@(GetNotificationColor(notification.Type))">
                                                    <i class="@GetNotificationIcon(notification.Type)"></i>
                                                </div>
                                                <small class="text-muted">@notification.CreatedDate.ToString("dd.MM.yyyy HH:mm")</small>
                                                <span class="badge bg-primary">Yeni</span>
                                            </div>
                                            @{
                                                var notificationUrl = GetNotificationUrl(notification.Type, notification.RequestId, notification.OfferId, notification.SupplierId);
                                            }
                                            <a href="@notificationUrl" class="notification-title-link" onclick="handleNotificationClickDashboard(@notification.Id, '@notificationUrl', event)">
                                                <h6 class="notification-title mb-1" style="color:#2385ba">@notification.Title</h6>
                                            </a>
                                            <p class="notification-message mb-2 text-muted">@notification.Message</p>
                                        </div>
                                        <div class="notification-actions">
                                            <button class="btn btn-sm btn-outline-primary btn-mark-read" onclick="markAsReadDashboard(@notification.Id)">
                                                <i class="ri-check-line"></i> Okundu olarak işaretle
                                            </button>
                                        </div>
                                    </div>
                                }
                            </div>
                            @if (Model.Notifications.Count() > 10)
                            {
                                <div class="notification-panel-footer">
                                    <a href="/Admin/Notifications" class="btn btn-link">
                                        Tüm Bildirimleri Görüntüle (@Model.Notifications.Count())
                                    </a>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }



            <!-- Product Search Section -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-lg-10 col-md-9">
                                    <div class="input-group">
                                        <span class="input-group-text bg-primary text-white">
                                            <i class="ri-search-line"></i>
                                        </span>
                                        <input type="text"
                                               class="form-control"
                                               id="productSearchInput"
                                               placeholder="Ürün adı veya kodu ile arama yapın (ör: nya, vida, boya...)"
                                               onkeypress="handleProductSearchKeyPress(event)" />
                                    </div>
                                </div>
                                <div class="col-lg-2 col-md-3 mt-2 mt-md-0">
                                    <button type="button"
                                            class="btn btn-primary w-100"
                                            onclick="searchProducts()">
                                        <i class="ri-search-2-line me-1"></i> Ara
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Product Search Results Modal -->
            <div class="modal fade" id="productSearchModal" tabindex="-1" aria-labelledby="productSearchModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title" id="productSearchModalLabel" style="color:white">
                                <i class="ri-search-line me-2"></i>Ürün Arama Sonuçları
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <!-- Loading State -->
                            <div id="productSearchLoading" class="product-search-loading" style="display: none;">
                                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                                    <span class="visually-hidden">Yükleniyor...</span>
                                </div>
                                <p class="mt-3 text-muted">Ürünler aranıyor...</p>
                            </div>

                            <!-- Error State -->
                            <div id="productSearchError" class="product-search-error" style="display: none;">
                                <i class="ri-error-warning-line display-4"></i>
                                <h5 class="mt-3">Bir Hata Oluştu</h5>
                                <p id="productSearchErrorMessage" class="text-muted"></p>
                            </div>

                            <!-- Empty State -->
                            <div id="productSearchEmpty" class="product-search-empty" style="display: none;">
                                <i class="ri-inbox-line display-4"></i>
                                <h5 class="mt-3">Ürün Bulunamadı</h5>
                                <p class="text-muted">Aradığınız kriterlere uygun ürün bulunamadı. Lütfen farklı bir arama terimi deneyin.</p>
                            </div>

                            <!-- Results State -->
                            <div id="productSearchResults" class="product-search-results" style="display: none;">
                                <div class="alert alert-info mb-3">
                                    <i class="ri-information-line me-2"></i>
                                    <strong id="productResultCount">0</strong> ürün bulundu
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-hover product-table">
                                        <thead>
                                            <tr>
                                                <th style="width: 25%;">Ürün Kodu</th>
                                                <th style="width: 60%;">Ürün Açıklaması</th>
                                                <th style="width: 15%;" class="text-end">Liste Fiyatı</th>
                                            </tr>
                                        </thead>
                                        <tbody id="productSearchTableBody">
                                            <!-- Results will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                <i class="ri-close-line me-1"></i> Kapat
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- KPI Cards Row -->
            <div class="row">
                <div class="col-xl-12">
                    <div class="card crm-widget">
                        <div class="card-body p-0">
                            <div class="row row-cols-xxl-5 row-cols-md-3 row-cols-1 g-0">
                                <div class="col">
                                    <div class="py-4 px-3">
                                        <h5 class="text-muted text-uppercase fs-13">Toplam Talepler <i class="ri-arrow-up-circle-line text-success fs-18 float-end align-middle"></i></h5>
                                        <div class="d-flex align-items-center">
                                            <div class="flex-shrink-0">
                                                <i class="ri-file-list-3-line display-6 text-muted"></i>
                                            </div>
                                            <div class="flex-grow-1 ms-3">
                                                <h2 class="mb-0"><span class="counter-value" data-target="@Model.Stats.TotalRequests">@Model.Stats.TotalRequests</span></h2>
                                            </div>
                                        </div>
                                    </div>
                                </div><!-- end col -->
                                <div class="col">
                                    <div class="mt-3 mt-md-0 py-4 px-3">
                                        <h5 class="text-muted text-uppercase fs-13">Bekleyen Talepler <i class="ri-time-line text-warning fs-18 float-end align-middle"></i></h5>
                                        <div class="d-flex align-items-center">
                                            <div class="flex-shrink-0">
                                                <i class="ri-timer-line display-6 text-muted"></i>
                                            </div>
                                            <div class="flex-grow-1 ms-3">
                                                <h2 class="mb-0"><span class="counter-value" data-target="@(Model.RecentRequests?.Count(r => r.Status == SantiyeTalepWebUI.Models.RequestStatus.Open) ?? 0)">@(Model.RecentRequests?.Count(r => r.Status == SantiyeTalepWebUI.Models.RequestStatus.Open) ?? 0)</span></h2>
                                            </div>
                                        </div>
                                    </div>
                                </div><!-- end col -->
                                <div class="col">
                                    <div class="mt-3 mt-md-0 py-4 px-3">
                                        <h5 class="text-muted text-uppercase fs-13">Tamamlanan Talepler <i class="ri-arrow-up-circle-line text-success fs-18 float-end align-middle"></i></h5>
                                        <div class="d-flex align-items-center">
                                            <div class="flex-shrink-0">
                                                <i class="ri-checkbox-circle-line display-6 text-muted"></i>
                                            </div>
                                            <div class="flex-grow-1 ms-3">
                                                <h2 class="mb-0"><span class="counter-value" data-target="@(Model.RecentRequests?.Count(r => r.Status == SantiyeTalepWebUI.Models.RequestStatus.Completed) ?? 0)">@(Model.RecentRequests?.Count(r => r.Status == SantiyeTalepWebUI.Models.RequestStatus.Completed) ?? 0)</span></h2>
                                            </div>
                                        </div>
                                    </div>
                                </div><!-- end col -->
                                <div class="col">
                                    <div class="mt-3 mt-lg-0 py-4 px-3">
                                        <h5 class="text-muted text-uppercase fs-13">Aktif Şantiyeler <i class="ri-arrow-up-circle-line text-success fs-18 float-end align-middle"></i></h5>
                                        <div class="d-flex align-items-center">
                                            <div class="flex-shrink-0">
                                                <i class="ri-building-2-line display-6 text-muted"></i>
                                            </div>
                                            <div class="flex-grow-1 ms-3">
                                                <h2 class="mb-0"><span class="counter-value" data-target="@(Model.Sites?.Count(s => s.IsActive) ?? 0)">@(Model.Sites?.Count(s => s.IsActive) ?? 0)</span></h2>
                                            </div>
                                        </div>
                                    </div>
                                </div><!-- end col -->
                                <div class="col">
                                    <div class="mt-3 mt-lg-0 py-4 px-3">
                                        <h5 class="text-muted text-uppercase fs-13">Toplam Çalışan <i class="ri-team-line text-info fs-18 float-end align-middle"></i></h5>
                                        <div class="d-flex align-items-center">
                                            <div class="flex-shrink-0">
                                                <i class="ri-group-line display-6 text-muted"></i>
                                            </div>
                                            <div class="flex-grow-1 ms-3">
                                                <h2 class="mb-0"><span class="counter-value" data-target="@Model.Stats.TotalUsers">@Model.Stats.TotalUsers</span></h2>
                                            </div>
                                        </div>
                                    </div>
                                </div><!-- end col -->
                            </div><!-- end row -->
                        </div><!-- end card body -->
                    </div><!-- end card -->
                </div><!-- end col -->
            </div><!-- end row -->

            <!-- Charts Row -->
            <div class="row">
                <div class="col-xxl-12 col-md-12">
                    <div class="card">
                        <div class="card-header border-0 align-items-center d-flex">
                            <h4 class="card-title mb-0 flex-grow-1">Şantiye Performansı</h4>
                            <div>
                                <button type="button" class="btn btn-soft-primary btn-sm" onclick="updateSitePerformancePeriod('1month')" id="btn-period-1month">
                                    1 AY
                                </button>
                                <button type="button" class="btn btn-soft-secondary btn-sm" onclick="updateSitePerformancePeriod('3months')" id="btn-period-3months">
                                    3 AY
                                </button>
                                <button type="button" class="btn btn-soft-secondary btn-sm" onclick="updateSitePerformancePeriod('6months')" id="btn-period-6months">
                                    6 AY
                                </button>
                                <button type="button" class="btn btn-soft-secondary btn-sm" onclick="updateSitePerformancePeriod('12months')" id="btn-period-12months">
                                    1 YIL
                                </button>
                            </div>
                        </div><!-- end card header -->

                        <div class="card-header p-0 border-0 bg-light-subtle">
                            <div class="row g-0 text-center">
                                <div class="col-6 col-sm-3">
                                    <div class="p-3 border border-dashed border-start-0">
                                        <h5 class="mb-1"><span class="counter-value" data-target="0" id="stat-total-sites">0</span></h5>
                                        <p class="text-muted mb-0">Toplam Şantiye</p>
                                    </div>
                                </div>
                                <!--end col-->
                                <div class="col-6 col-sm-3">
                                    <div class="p-3 border border-dashed border-start-0">
                                        <h5 class="mb-1"><span class="counter-value" data-target="0" id="stat-total-requests">0</span></h5>
                                        <p class="text-muted mb-0">Toplam Talep</p>
                                    </div>
                                </div>
                                <!--end col-->
                                <div class="col-6 col-sm-3">
                                    <div class="p-3 border border-dashed border-start-0">
                                        <h5 class="mb-1"><span class="counter-value" data-target="0" id="stat-total-employees">0</span></h5>
                                        <p class="text-muted mb-0">Toplam Çalışan</p>
                                    </div>
                                </div>
                                <!--end col-->
                                <div class="col-6 col-sm-3">
                                    <div class="p-3 border border-dashed border-start-0 border-end-0">
                                        <h5 class="mb-1 text-success"><span class="counter-value" data-target="0" id="stat-completed-requests">0</span></h5>
                                        <p class="text-muted mb-0">Tamamlanan Talep</p>
                                    </div>
                                </div>
                                <!--end col-->
                            </div>
                        </div><!-- end card header -->

                        <div class="card-body p-0 pb-2">
                            <div class="d-flex justify-content-between align-items-center px-3 pt-3 pb-2">
                                <div>
                                    <button type="button" class="btn btn-soft-secondary btn-sm" onclick="updateSitePerformanceView('requests')" id="btn-requests">
                                        <i class="ri-file-list-line me-1"></i>Talepler
                                    </button>
                                    <button type="button" class="btn btn-soft-secondary btn-sm" onclick="updateSitePerformanceView('employees')" id="btn-employees">
                                        <i class="ri-team-line me-1"></i>Çalışanlar
                                    </button>
                                    <button type="button" class="btn btn-soft-primary btn-sm" onclick="updateSitePerformanceView('comparison')" id="btn-comparison">
                                        <i class="ri-bar-chart-grouped-line me-1"></i>Karşılaştırma
                                    </button>
                                </div>
                            </div>
                            <div>
                                <div id="site-performance-chart" data-colors='["--vz-primary", "--vz-success", "--vz-warning"]' dir="ltr" class="apex-charts"></div>
                            </div>
                        </div><!-- end card body -->
                    </div><!-- end card -->
                </div><!-- end col -->
            </div><!-- end row -->

            <!-- Data Tables Row -->
            <div class="row">
                <div class="col-6">
                    <div class="row">
                        <div class="col-xxl-12 col-md-12">
                            <div class="card">
                                <div class="card-header align-items-center d-flex">
                                    <h4 class="card-title mb-0 flex-grow-1">Talep Durumu Dağılımı</h4>
                                    <div class="flex-shrink-0">
                                        <div class="dropdown card-header-dropdown">
                                            <a class="text-reset dropdown-btn" href="#" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                <span class="fw-semibold text-uppercase fs-12">Filtre: </span><span class="text-muted" id="statusChartFilterText">Bu Ay<i class="mdi mdi-chevron-down ms-1"></i></span>
                                            </a>
                                            <div class="dropdown-menu dropdown-menu-end">
                                                <a class="dropdown-item" href="javascript:void(0)" onclick="updateRequestStatusChart('today')">Bugün</a>
                                                <a class="dropdown-item" href="javascript:void(0)" onclick="updateRequestStatusChart('week')">Bu Hafta</a>
                                                <a class="dropdown-item" href="javascript:void(0)" onclick="updateRequestStatusChart('month')">Bu Ay</a>
                                                <a class="dropdown-item" href="javascript:void(0)" onclick="updateRequestStatusChart('3months')">Son 3 Ay</a>
                                                <a class="dropdown-item" href="javascript:void(0)" onclick="updateRequestStatusChart('year')">Bu Yıl</a>
                                            </div>
                                        </div>
                                    </div>
                                </div><!-- end card header -->
                                <div class="card-body pb-0">
                                    <div id="request-status-chart" data-colors='["--vz-warning", "--vz-primary", "--vz-success", "--vz-danger"]' class="apex-charts" dir="ltr"></div>
                                </div>
                            </div><!-- end card -->
                        </div><!-- end col -->
                    </div>
                </div>

                <div class="col-6">
                    <div class="card card-height-100">
                        <div class="card-header align-items-center d-flex">
                            <h4 class="card-title mb-0 flex-grow-1">Aktif Şantiyeler</h4>
                            <div class="flex-shrink-0">
                                <select class="form-select form-select-sm" aria-label="Şantiye Filtresi">
                                    <option selected="">Tüm Şantiyeler</option>
                                    <option value="1">Aktif Projeler</option>
                                    <option value="2">Tamamlanan Projeler</option>
                                    <option value="3">Bekleyen Projeler</option>
                                </select>
                            </div>
                        </div><!-- end card header -->

                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered table-nowrap align-middle mb-0">
                                    <thead>
                                        <tr>
                                            <th scope="col" style="width: 50%;">Şantiye Adı</th>
                                            <th scope="col" style="width: 30%;">Çalışan Sayısı</th>
                                            <th scope="col" style="width: 20%;">Durum</th>
                                        </tr>
                                    </thead>

                                    <tbody>
                                        @if (Model.Sites?.Any() == true)
                                        {
                                            @foreach (var site in Model.Sites.Take(5))
                                            {
                                                <tr>
                                                    <td>@site.Name</td>
                                                    <td>
                                                        <span class="badge bg-primary">@(site.Employees?.Count ?? 0) çalışan</span>
                                                    </td>
                                                    <td>
                                                        @if (site.IsActive)
                                                        {
                                                            <span class="badge bg-success">Aktif</span>
                                                        }
                                                        else
                                                        {
                                                            <span class="badge bg-secondary">Pasif</span>
                                                        }
                                                    </td>
                                                </tr>
                                            }
                                        }
                                        else
                                        {
                                            <tr>
                                                <td colspan="3" class="text-center text-muted">Henüz şantiye bulunmuyor</td>
                                            </tr>
                                        }
                                    </tbody><!-- end tbody -->
                                </table><!-- end table -->
                            </div><!-- end table responsive -->
                        </div><!-- end card body -->
                    </div><!-- end card -->
                </div><!-- end col -->
            </div><!-- end row -->

            <!-- Employee List Row -->
            <div class="row">
                <div class="col-6">
                    <div class="card">
                        <div class="card-header align-items-center d-flex">
                            <h4 class="card-title mb-0 flex-grow-1">Son Talepler</h4>
                            <div class="flex-shrink-0">
                                <div class="dropdown card-header-dropdown">
                                    <a class="text-reset dropdown-btn" href="#" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        <span class="text-muted">Son 7 Gün<i class="mdi mdi-chevron-down ms-1"></i></span>
                                    </a>
                                    <div class="dropdown-menu dropdown-menu-end">
                                        <a class="dropdown-item" href="#">Bugün</a>
                                        <a class="dropdown-item" href="#">Son 7 Gün</a>
                                        <a class="dropdown-item" href="#">Son 30 Gün</a>
                                        <a class="dropdown-item" href="#">Bu Yıl</a>
                                    </div>
                                </div>
                            </div>
                        </div><!-- end card header -->

                        <div class="card-body">
                            <div class="table-responsive table-card">
                                <table class="table table-borderless table-hover table-nowrap align-middle mb-0">
                                    <thead class="table-light">
                                        <tr class="text-muted">
                                            <th scope="col">Talep No</th>
                                            <th scope="col" style="width: 20%;">Şantiye</th>
                                            <th scope="col">Talep Eden</th>
                                            <th scope="col" style="width: 16%;">Durum</th>
                                            <th scope="col" style="width: 12%;">Tarih</th>
                                        </tr>
                                    </thead>

                                    <tbody>
                                        @if (Model.RecentRequests?.Any() == true)
                                        {
                                            @foreach (var request in Model.RecentRequests.Take(5))
                                            {
                                                <tr>
                                                    <td>#TLP-@request.Id.ToString("D4")</td>
                                                    <td>@(request.SiteName ?? "Bilinmiyor")</td>
                                                    <td>
                                                        <img src="~/assets/images/users/avatar-1.jpg" alt="" class="avatar-xs rounded-circle me-2">
                                                        <a href="#javascript: void(0);" class="text-body fw-medium">@(request.EmployeeName ?? "Bilinmiyor")</a>
                                                    </td>
                                                    <td>
                                                        @{
                                                            var statusClass = request.Status switch
                                                            {
                                                                SantiyeTalepWebUI.Models.RequestStatus.Open => "bg-warning-subtle text-warning",
                                                                SantiyeTalepWebUI.Models.RequestStatus.Completed => "bg-success-subtle text-success",
                                                                SantiyeTalepWebUI.Models.RequestStatus.Cancelled => "bg-danger-subtle text-danger",
                                                                _ => "bg-info-subtle text-info"
                                                            };
                                                            var statusText = request.Status switch
                                                            {
                                                                SantiyeTalepWebUI.Models.RequestStatus.Open => "Açık",
                                                                SantiyeTalepWebUI.Models.RequestStatus.Completed => "Tamamlandı",
                                                                SantiyeTalepWebUI.Models.RequestStatus.Cancelled => "İptal",
                                                                _ => "İncelemede"
                                                            };
                                                        }
                                                        <span class="badge @statusClass p-2">@statusText</span>
                                                    </td>
                                                    <td>
                                                        <div class="text-nowrap">@request.RequestDate.ToString("dd MMM, yyyy")</div>
                                                    </td>
                                                </tr>
                                            }
                                        }
                                        else
                                        {
                                            <tr>
                                                <td colspan="5" class="text-center text-muted">Henüz talep bulunmuyor</td>
                                            </tr>
                                        }
                                    </tbody><!-- end tbody -->
                                </table><!-- end table -->
                            </div><!-- end table responsive -->
                        </div><!-- end card body -->
                    </div><!-- end card -->
                </div><!-- end col -->
                
                <div class="col-6">
                    <div class="card">
                        <div class="card-header align-items-center d-flex">
                            <h4 class="card-title mb-0 flex-grow-1">Son Eklenen Çalışanlar</h4>
                            <div class="flex-shrink-0">
                                <a href="/Admin/Employees" class="btn btn-primary btn-sm">Tümünü Gör</a>
                            </div>
                        </div><!-- end card header -->

                        <div class="card-body">
                            <div class="table-responsive table-card">
                                <table class="table table-borderless table-hover table-nowrap align-middle mb-0">
                                    <thead class="table-light">
                                        <tr class="text-muted">
                                            <th scope="col">Çalışan</th>
                                            <th scope="col">Şantiye</th>
                                            <th scope="col">Pozisyon</th>
                                            <th scope="col">E-posta</th>
                                            <th scope="col">Durum</th>
                                            <th scope="col">Kayıt Tarihi</th>
                                        </tr>
                                    </thead>

                                    <tbody>
                                        @if (Model.Employees?.Any() == true)
                                        {
                                            @foreach (var employee in Model.Employees.Take(5))
                                            {
                                                <tr>
                                                    <td>
                                                        <img src="~/assets/images/users/avatar-1.jpg" alt="" class="avatar-xs rounded-circle me-2">
                                                        <a href="#javascript: void(0);" class="text-body fw-medium">@employee.FullName</a>
                                                    </td>
                                                    <td>@(employee.SiteName ?? "Atanmamış")</td>
                                                    <td>@(employee.Position ?? "-")</td>
                                                    <td>@employee.Email</td>
                                                    <td>
                                                        @if (employee.IsActive)
                                                        {
                                                            <span class="badge bg-success-subtle text-success p-2">Aktif</span>
                                                        }
                                                        else
                                                        {
                                                            <span class="badge bg-danger-subtle text-danger p-2">Pasif</span>
                                                        }
                                                    </td>
                                                    <td>
                                                        <div class="text-nowrap">@employee.CreatedDate.ToString("dd MMM, yyyy")</div>
                                                    </td>
                                                </tr>
                                            }
                                        }
                                        else
                                        {
                                            <tr>
                                                <td colspan="6" class="text-center text-muted">Henüz çalışan bulunmuyor</td>
                                            </tr>
                                        }
                                    </tbody><!-- end tbody -->
                                </table><!-- end table -->
                            </div><!-- end table responsive -->
                        </div><!-- end card body -->
                    </div><!-- end card -->
                </div><!-- end col -->
            </div><!-- end row -->

        </div>
        <!-- container-fluid -->
    </div>
    <!-- End Page-content -->

    <footer class="footer">
        <div class="container-fluid">
            <div class="row">
                <div class="col-sm-6">
                    <script>document.write(new Date().getFullYear())</script> © Şantiye Talep Yönetim Sistemi.
                </div>
                <div class="col-sm-6">
                    <div class="text-sm-end d-none d-sm-block">
                        <a href="https://www.urssoft.com">UrsSoft Teknoloji A.Ş.</a> tarafından geliştirildi.
                    </div>
                </div>
            </div>
        </div>
    </footer>
</div>
<!-- end main content-->

<!-- Real-time status indicator -->
<div class="realtime-status" id="realtimeStatus">
    <div class="status-dot"></div>
    <span>Canlı takip aktif</span>
</div>

@section Scripts {
<script>
    let requestStatusChart = null; // Global değişken

    // ========================================
    // PRODUCT SEARCH FUNCTIONS
    // ========================================

    function handleProductSearchKeyPress(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            searchProducts();
        }
    }

    async function searchProducts() {
        const searchInput = document.getElementById('productSearchInput');
        const searchQuery = searchInput.value.trim();

        if (!searchQuery || searchQuery.length < 2) {
            Swal.fire({
                icon: 'warning',
                title: 'Geçersiz Arama',
                text: 'Lütfen en az 2 karakter uzunluğunda bir arama terimi girin.',
                confirmButtonText: 'Tamam'
            });
            return;
        }

        const modal = new bootstrap.Modal(document.getElementById('productSearchModal'));
        modal.show();

        showProductSearchState('loading');

        try {
            const apiUrl = `https://www.teklifalani.com/api/searchapi?query=${encodeURIComponent(searchQuery)}`;
            console.log('Searching products:', apiUrl);

            const response = await fetch(apiUrl);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            console.log('API Response:', result);

            const data = result.data;

            if (!data || !Array.isArray(data) || data.length === 0) {
                showProductSearchState('empty');
                return;
            }

            displayProductResults(data);

        } catch (error) {
            console.error('Product search error:', error);
            showProductSearchState('error', error.message);
        }
    }

    function showProductSearchState(state, errorMessage = '') {
        const loading = document.getElementById('productSearchLoading');
        const error = document.getElementById('productSearchError');
        const empty = document.getElementById('productSearchEmpty');
        const results = document.getElementById('productSearchResults');

        loading.style.display = 'none';
        error.style.display = 'none';
        empty.style.display = 'none';
        results.style.display = 'none';

        switch(state) {
            case 'loading':
                loading.style.display = 'block';
                break;
            case 'error':
                error.style.display = 'block';
                document.getElementById('productSearchErrorMessage').textContent =
                    errorMessage || 'Ürün arama sırasında bir hata oluştu. Lütfen tekrar deneyin.';
                break;
            case 'empty':
                empty.style.display = 'block';
                break;
            case 'results':
                results.style.display = 'block';
                break;
        }
    }

    function displayProductResults(products) {
        const tableBody = document.getElementById('productSearchTableBody');
        const resultCount = document.getElementById('productResultCount');

        resultCount.textContent = products.length;
        tableBody.innerHTML = '';

        products.forEach((product, index) => {
            const row = document.createElement('tr');

            const productCode = product.productCode || product.code || product.id || '-';
            const productDescription = product.description || product.name || product.productName || 'Açıklama yok';
            const listPrice = product.listPrice || product.price || product.unitPrice || 0;
            const currency = product.currency || '₺';
            const brandName = product.brand?.name || '-';

            let formattedPrice;

            if (currency === '₺' || currency === 'TRY' || currency === 'TL') {
                formattedPrice = new Intl.NumberFormat('tr-TR', {
                    style: 'currency',
                    currency: 'TRY',
                    minimumFractionDigits: 2
                }).format(listPrice);
            } else if (currency === '$' || currency === 'USD') {
                formattedPrice = new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 2
                }).format(listPrice);
            } else if (currency === '€' || currency === 'EUR') {
                formattedPrice = new Intl.NumberFormat('de-DE', {
                    style: 'currency',
                    currency: 'EUR',
                    minimumFractionDigits: 2
                }).format(listPrice);
            } else if (currency === '£' || currency === 'GBP') {
                formattedPrice = new Intl.NumberFormat('en-GB', {
                    style: 'currency',
                    currency: 'GBP',
                    minimumFractionDigits: 2
                }).format(listPrice);
            } else {
                formattedPrice = `${listPrice.toLocaleString('tr-TR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                })} ${currency}`;
            }

            row.innerHTML = `
                <td>
                    <div>
                        <span class="product-code fw-semibold">${productCode}</span>
                        ${brandName !== '-' ? `<br><small class="text-muted"><i class="ri-building-line me-1"></i>${brandName}</small>` : ''}
                    </div>
                </td>
                <td>
                    <div class="text-truncate" style="max-width: 500px;" title="${productDescription}">
                        ${productDescription}
                    </div>
                </td>
                <td class="text-end">
                    <div class="product-price fw-semibold fs-15">${formattedPrice}</div>
                </td>
            `;

            tableBody.appendChild(row);
        });

        showProductSearchState('results');
    }

        async function markAsReadDashboard(notificationId) {
            console.log('Dashboard: markAsRead called with ID:', notificationId);

            try {
                const response = await fetch('/Admin/MarkNotificationAsRead', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify(notificationId)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    return false;
                }

                const result = await response.json();
                console.log('Dashboard: API response result:', result);

                if (result.success) {
                    // ✅ SAYFA YENİLEME (Dashboard'da bildirim sayısını güncellemek için)
                    window.location.reload();
                    return true;
                }

                return false;
            } catch (error) {
                console.error('Dashboard: Error marking notification as read:', error);
                return false;
            }
        }

        async function markAllAsReadDashboard() {
            try {
                const response = await fetch('/Admin/MarkAllNotificationsAsRead', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        // ✅ SAYFA YENİLEME (Dashboard'da bildirim sayısını güncellemek için)
                        window.location.reload();
                    }
                }
            } catch (error) {
                console.error('Dashboard: Error marking all notifications as read:', error);
            }
        }

        function toggleNotificationPanel() {
            const panel = document.getElementById('notificationPanel');
            const alertRow = document.querySelector('.alert.alert-info'); // Bildirim alert'i

            if (panel) {
                if (panel.style.display === 'none' || panel.style.display === '') {
                    panel.style.display = 'block';
                    setTimeout(() => {
                        panel.classList.add('show');
                    }, 10);
                } else {
                    panel.classList.remove('show');
                    setTimeout(() => {
                        panel.style.display = 'none';
                    }, 300);
                }
            }

            // ✅ Bildirim sayısı 0 ise alert'i gizle
            const unreadItems = document.querySelectorAll('.notification-item.unread');
            if (unreadItems.length === 0 && alertRow) {
                alertRow.style.display = 'none';
            }
        }

        function handleNotificationClickDashboard(notificationId, url, event) {
            event.preventDefault();

            const notificationItem = document.querySelector(`[data-id="${notificationId}"]`);
            const isUnread = notificationItem && notificationItem.classList.contains('unread');

            if (isUnread) {
                markAsReadDashboard(notificationId).then(() => {
                    // Sayfa zaten yenilenecek, yönlendirmeye gerek yok
                });
            } else {
                window.location.href = url;
            }
        }


        function updateDashboardNotificationCounts(count = null) {
            if (count === null) {
                count = document.querySelectorAll('.notification-item.unread').length;
            }

            const countElements = document.querySelectorAll('.notifications-count');
            countElements.forEach(el => {
                el.textContent = count;
                if (count === 0) {
                    el.style.display = 'none';
                }
            });
        }

        function checkAndHideAlertIfAllReadDashboard() {
            const unreadItems = document.querySelectorAll('.notification-item.unread');
            if (unreadItems.length === 0) {
                const alert = document.getElementById('notificationAlert');
                if (alert) alert.style.display = 'none';

                const markAllBtn = document.querySelector('button[onclick="markAllAsReadDashboard()"]');
                if (markAllBtn) markAllBtn.style.display = 'none';

                const headerBadge = document.querySelector('.notification-panel-header .badge');
                if (headerBadge) headerBadge.remove();
            }
        }

        // ========================================
        // SAYFA YÜKLENDİĞİNDE ÇALIŞACAK KODLAR
        // ========================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard yüklendi');

            // Counter animasyonu
            const counters = document.querySelectorAll('.counter-value');
            counters.forEach(counter => {
                const target = parseInt(counter.getAttribute('data-target'));
                if (!isNaN(target)) {
                    const start = 0;
                    const duration = 1000;
                    const step = (target - start) / (duration / 16);

                    let current = start;
                    const timer = setInterval(() => {
                        current += step;
                        if (current >= target) {
                            current = target;
                            clearInterval(timer);
                        }
                        counter.textContent = Math.floor(current);
                    }, 16);
                }
            });

            // Bildirimleri yükle
            loadNotificationSummary();
            setInterval(loadNotificationSummary, 30000);

            // Grafikleri başlat
            initializeCharts();

            // Status indicator göster
            setTimeout(() => {
                const statusIndicator = document.getElementById('realtimeStatus');
                if (statusIndicator) {
                    statusIndicator.classList.add('active');
                    setTimeout(() => {
                        statusIndicator.classList.remove('active');
                    }, 3000);
                }
            }, 2000);
        });

        // Initialize charts with error handling
        function initializeCharts() {
            try {
                // Request Status Chart
                const requestStatusElement = document.querySelector("#request-status-chart");
                if (requestStatusElement) {
                    var openCount = @(Model.RecentRequests?.Count(r => r.Status == SantiyeTalepWebUI.Models.RequestStatus.Open) ?? 0);
                    var inProgressCount = @(Model.RecentRequests?.Count(r => r.Status == SantiyeTalepWebUI.Models.RequestStatus.InProgress) ?? 0);
                    var completedCount = @(Model.RecentRequests?.Count(r => r.Status == SantiyeTalepWebUI.Models.RequestStatus.Completed) ?? 0);
                    var cancelledCount = @(Model.RecentRequests?.Count(r => r.Status == SantiyeTalepWebUI.Models.RequestStatus.Cancelled) ?? 0);

                    var requestStatusOptions = {
                        series: [openCount, inProgressCount, completedCount, cancelledCount],
                        chart: {
                            type: 'donut',
                            height: 230
                        },
                        labels: ['Açık', 'İşlemde', 'Tamamlanan', 'İptal'],
                        colors: ['#f1b44c', '#556ee6', '#34c38f', '#f46a6a'],
                        legend: {
                            position: 'bottom'
                        }
                    };
                    requestStatusChart = new ApexCharts(requestStatusElement, requestStatusOptions);
                    requestStatusChart.render();
                }

                // Site Performance Chart - Load with default period
                loadSitePerformanceChart('1month');
            } catch (error) {
                console.error('Chart initialization error:', error);
            }
        }

        // Talep Durumu grafiğini güncelle
        function updateRequestStatusChart(period) {
            const filterTextMap = {
                'today': 'Bugün',
                'week': 'Bu Hafta',
                'month': 'Bu Ay',
                '3months': 'Son 3 Ay',
                'year': 'Bu Yıl'
            };

            const filterTextElement = document.getElementById('statusChartFilterText');
            if (filterTextElement) {
                filterTextElement.innerHTML = filterTextMap[period] + '<i class="mdi mdi-chevron-down ms-1"></i>';
            }

            fetch(`/Admin/GetRequestStatusData?period=${period}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && requestStatusChart) {
                        requestStatusChart.updateSeries([
                            data.openCount || 0,
                            data.inProgressCount || 0,
                            data.completedCount || 0,
                            data.cancelledCount || 0
                        ]);
                    } else if (!data.success) {
                        console.error('Grafik verileri alınamadı:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Grafik güncellenirken hata:', error);
                });
        }


    // ========================================
    // SITE PERFORMANCE CHART FUNCTIONS
    // ========================================

    function loadSitePerformanceChart(period = '1month') {
        const chartElement = document.querySelector("#site-performance-chart");
        if (!chartElement) {
            console.error('Chart element not found');
            return;
        }

        chartElement.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-2 text-muted">Yükleniyor...</p></div>';

        fetch(`/Admin/GetSitePerformanceData?period=${period}`)
            .then(response => response.json())
            .then(result => {
                if (result.success && result.data && result.data.data) {
                    const performanceData = result.data.data;

                    window.sitePerformanceData = performanceData;
                                           window.currentPeriod = period;

                        updateSitePerformanceStats(performanceData);
                        renderSitePerformanceChart(performanceData);

                        setActivePeriodButton(period);
                        setActiveViewButton('comparison');
                    } else {
                        chartElement.innerHTML = `
                            <div class="text-center py-5">
                                <i class="ri-building-2-line display-4 text-muted"></i>
                                <p class="text-muted mt-2">Şantiye performans verisi bulunamadı</p>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Site performance chart error:', error);
                    chartElement.innerHTML = `
                        <div class="text-center py-5">
                            <i class="ri-error-warning-line display-4 text-danger"></i>
                            <p class="text-muted mt-2">Grafik yüklenirken hata oluştu</p>
                        </div>
                    `;
                });
        }

        function renderSitePerformanceChart(data) {
            const chartElement = document.querySelector("#site-performance-chart");
            if (!chartElement) return;

            chartElement.innerHTML = '';

            if (window.sitePerformanceChart) {
                window.sitePerformanceChart.destroy();
            }

            const siteNames = data.map(site => site.siteName);
            const totalRequests = data.map(site => site.totalRequests);
            const completedRequests = data.map(site => site.completedRequests);
            const openRequests = data.map(site => site.openRequests);
            const cancelledRequests = data.map(site => site.cancelledRequests);

            const chartOptions = {
                series: [
                    {
                        name: 'Toplam Talep',
                        data: totalRequests
                    },
                    {
                        name: 'Tamamlanan',
                        data: completedRequests
                    },
                    {
                        name: 'Açık',
                        data: openRequests
                    },
                    {
                        name: 'İptal',
                        data: cancelledRequests
                    }
                ],
                chart: {
                    type: 'bar',
                    height: 350,
                    toolbar: {
                        show: true,
                        tools: {
                            download: true,
                            selection: false,
                            zoom: false,
                            zoomin: false,
                            zoomout: false,
                            pan: false,
                            reset: false
                        }
                    }
                },
                plotOptions: {
                    bar: {
                        horizontal: false,
                        columnWidth: '55%',
                        endingShape: 'rounded',
                        borderRadius: 4
                    }
                },
                dataLabels: {
                    enabled: false
                },
                stroke: {
                    show: true,
                    width: 2,
                    colors: ['transparent']
                },
                xaxis: {
                    categories: siteNames,
                    labels: {
                        rotate: -45,
                        rotateAlways: siteNames.length > 5,
                        trim: true,
                        maxHeight: 120,
                        style: {
                            fontSize: '12px'
                        }
                    }
                },
                yaxis: {
                    title: {
                        text: 'Talep Sayısı',
                        style: {
                            fontSize: '13px',
                            fontWeight: 500
                        }
                    }
                },
                fill: {
                    opacity: 1
                },
                tooltip: {
                    y: {
                        formatter: function (val) {
                            return val + " talep"
                        }
                    }
                },
                colors: ['#556ee6', '#34c38f', '#f1b44c', '#f46a6a'],
                legend: {
                    position: 'top',
                    horizontalAlign: 'left',
                    offsetY: 0
                },
                grid: {
                    borderColor: '#f1f1f1'
                }
            };

            window.sitePerformanceChart = new ApexCharts(chartElement, chartOptions);
            window.sitePerformanceChart.render();
        }

        function updateSitePerformancePeriod(period) {
            setActivePeriodButton(period);
            loadSitePerformanceChart(period);
        }

        function setActivePeriodButton(period) {
            document.querySelectorAll('[id^="btn-period-"]').forEach(btn => {
                btn.classList.remove('btn-soft-primary');
                btn.classList.add('btn-soft-secondary');
            });

            const activeBtn = document.getElementById(`btn-period-${period}`);
            if (activeBtn) {
                activeBtn.classList.remove('btn-soft-secondary');
                activeBtn.classList.add('btn-soft-primary');
            }
        }

        function setActiveViewButton(viewType) {
            document.querySelectorAll('#btn-requests, #btn-employees, #btn-comparison').forEach(btn => {
                btn.classList.remove('btn-soft-primary');
                btn.classList.add('btn-soft-secondary');
            });

            const activeBtn = document.getElementById(`btn-${viewType}`);
            if (activeBtn) {
                activeBtn.classList.remove('btn-soft-secondary');
                activeBtn.classList.add('btn-soft-primary');
            }
        }

        function updateSitePerformanceView(viewType) {
            if (!window.sitePerformanceChart || !window.sitePerformanceData) {
                console.error('Chart or data not available');
                return;
            }

            const data = window.sitePerformanceData;
            let series = [];
            let yAxisTitle = '';
            let tooltipFormatter = null;

            switch(viewType) {
                case 'requests':
                    series = [
                        {
                            name: 'Toplam Talep',
                            data: data.map(site => site.totalRequests)
                        },
                        {
                            name: 'Tamamlanan',
                            data: data.map(site => site.completedRequests)
                        },
                        {
                            name: 'Açık',
                            data: data.map(site => site.openRequests)
                        },
                        {
                            name: 'İptal',
                            data: data.map(site => site.cancelledRequests)
                        }
                    ];
                    yAxisTitle = 'Talep Sayısı';
                    tooltipFormatter = function(val) { return val + " talep"; };
                    break;

                case 'employees':
                    series = [
                        {
                            name: 'Çalışan Sayısı',
                            data: data.map(site => site.employeeCount)
                        }
                    ];
                    yAxisTitle = 'Çalışan Sayısı';
                    tooltipFormatter = function(val) { return val + " çalışan"; };
                    break;

                case 'comparison':
                default:
                    series = [
                        {
                            name: 'Toplam Talep',
                            data: data.map(site => site.totalRequests)
                        },
                        {
                            name: 'Çalışan Sayısı',
                            data: data.map(site => site.employeeCount)
                        },
                        {
                            name: 'Çalışan Başına Talep',
                            data: data.map(site => {
                                return site.employeeCount > 0 ?
                                    parseFloat((site.totalRequests / site.employeeCount).toFixed(2)) : 0;
                            })
                        }
                    ];
                    yAxisTitle = 'Sayı';
                    tooltipFormatter = function(val, opts) {
                        const seriesName = opts.w.config.series[opts.seriesIndex].name;
                        if (seriesName === 'Çalışan Başına Talep') {
                            return val.toFixed(2) + " talep/çalışan";
                        } else if (seriesName === 'Çalışan Sayısı') {
                            return val + " çalışan";
                        }
                        return val + " talep";
                    };
                    break;
            }

            setActiveViewButton(viewType);

            window.sitePerformanceChart.updateOptions({
                series: series,
                yaxis: {
                    title: {
                        text: yAxisTitle,
                        style: {
                            fontSize: '13px',
                            fontWeight: 500
                        }
                    }
                },
                tooltip: {
                    y: {
                        formatter: tooltipFormatter
                    }
                }
            });
        }

        function updateSitePerformanceStats(data) {
            if (!data || data.length === 0) return;

            const totalSites = data.length;
            const totalRequests = data.reduce((sum, site) => sum + site.totalRequests, 0);
            const totalEmployees = data.reduce((sum, site) => sum + site.employeeCount, 0);
            const completedRequests = data.reduce((sum, site) => sum + site.completedRequests, 0);

            animateCounter('stat-total-sites', totalSites);
            animateCounter('stat-total-requests', totalRequests);
            animateCounter('stat-total-employees', totalEmployees);
            animateCounter('stat-completed-requests', completedRequests);
        }

        function animateCounter(elementId, targetValue) {
            const element = document.getElementById(elementId);
            if (!element) return;

            const duration = 1000;
            const start = 0;
            const increment = targetValue / (duration / 16);

            let current = start;
            const timer = setInterval(() => {
                current += increment;
                if (current >= targetValue) {
                    current = targetValue;
                    clearInterval(timer);
                }
                element.textContent = Math.floor(current);
            }, 16);
        }

        function loadNotificationSummary() {
            fetch('/Admin/GetNotificationSummary')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.summary) {
                        updateNotificationCounts(data.summary.unreadCount);

                        const alertRow = document.getElementById('notificationAlertRow');
                        if (alertRow) {
                            if (data.summary.unreadCount > 0) {
                                alertRow.style.display = 'block';
                            } else {
                                alertRow.style.display = 'none';
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('Bildirim özeti yüklenirken hata:', error);
                });
        }

        function updateNotificationCounts(unreadCount) {
            const unreadCountElement = document.getElementById('unread-count');
            if (unreadCountElement) {
                unreadCountElement.textContent = unreadCount;
            }

            const panelUnreadCount = document.getElementById('panel-unread-count');
            if (panelUnreadCount) {
                if (unreadCount > 0) {
                    panelUnreadCount.textContent = unreadCount;
                    panelUnreadCount.style.display = 'inline-block';
                } else {
                    panelUnreadCount.style.display = 'none';
                }
            }

            const markAllReadBtn = document.getElementById('markAllReadBtn');
            if (markAllReadBtn) {
                if (unreadCount > 0) {
                    markAllReadBtn.style.display = 'inline-block';
                } else {
                    markAllReadBtn.style.display = 'none';
                }
            }
        }

    </script>
}

@functions {
    private string GetNotificationIcon(NotificationType type)
    {
        return type switch
        {
            NotificationType.SupplierRegistration => "ri-user-add-line",
            NotificationType.NewRequest => "ri-file-add-line",
            NotificationType.NewOffer => "ri-price-tag-3-line",
            NotificationType.OfferApproved => "ri-check-line",
            NotificationType.OfferRejected => "ri-close-line",
            NotificationType.ExcelRequestAssigned => "ri-file-excel-line",
            NotificationType.ExcelOfferUploaded => "ri-upload-line",
            _ => "ri-notification-line"
        };
    }

    private string GetNotificationColor(NotificationType type)
    {
        return type switch
        {
            NotificationType.SupplierRegistration => "success",
            NotificationType.NewRequest => "info",
            NotificationType.NewOffer => "warning",
            NotificationType.OfferApproved => "success",
            NotificationType.OfferRejected => "danger",
            NotificationType.ExcelRequestAssigned => "info",
            NotificationType.ExcelOfferUploaded => "primary",
            _ => "primary"
        };
    }

    private string GetNotificationUrl(NotificationType type, int? requestId, int? offerId, int? supplierId)
    {
        return type switch
        {
            NotificationType.SupplierRegistration => "/Admin/Suppliers",
            NotificationType.NewRequest => "/Admin/Requests" + (requestId.HasValue ? $"?requestId={requestId}" : ""),
            NotificationType.NewOffer => "/Admin/Offers" + (offerId.HasValue ? $"?offerId={offerId}" : ""),
            NotificationType.OfferApproved => "/Admin/Offers" + (offerId.HasValue ? $"?offerId={offerId}" : ""),
            NotificationType.OfferRejected => "/Admin/Offers" + (offerId.HasValue ? $"?offerId={offerId}" : ""),
            NotificationType.ExcelRequestAssigned => "/Admin/ExcelManagement" + (requestId.HasValue ? $"?requestId={requestId}" : ""),
            NotificationType.ExcelOfferUploaded => "/Admin/SupplierExcelManagement" + (requestId.HasValue ? $"?requestId={requestId}" : ""),
            _ => "/Admin/Dashboard"
        };
    }
}

