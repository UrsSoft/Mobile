@model SantiyeTalepWebUI.Models.ViewModels.AdminDashboardViewModel
@{
    ViewData["Title"] = "Admin Dashboard";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- Add notification checker styles -->
@section Styles {
    <link href="~/css/notification-checker.css" rel="stylesheet" />
}

<div class="main-content" data-enable-notifications="true">
    <div class="page-content">
        <div class="container-fluid">

            <!-- start page title -->
            <div class="row">
                <div class="col-12">
                    <div class="page-title-box d-sm-flex align-items-center justify-content-between">
                        <h4 class="mb-sm-0">Şantiye Talep Yönetim Sistemi</h4>

                        <div class="page-title-right">
                            <ol class="breadcrumb m-0">
                                <li class="breadcrumb-item"><a href="javascript: void(0);">Ana Sayfa</a></li>
                                <li class="breadcrumb-item active">Dashboard</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
            <!-- end page title -->
            <!-- Bildirimler Kartı -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body p-3">
                            <div class="d-flex align-items-center justify-content-between">
                                <div class="d-flex align-items-center">
                                    <div class="avatar-sm me-3">
                                        <div class="avatar-title bg-primary-subtle text-primary rounded-circle">
                                            <i class="ri-notification-3-line fs-16"></i>
                                        </div>
                                    </div>
                                    <div>
                                        <h6 class="mb-1">Son Bildirimler</h6>
                                        <p class="text-muted mb-0">
                                            <span id="unread-count" class="badge bg-danger me-2">0</span>
                                            okunmamış bildirim
                                        </p>
                                    </div>
                                </div>
                                <div>
                                    <button type="button" class="btn btn-sm btn-primary" onclick="loadNotifications()">
                                        <i class="ri-eye-line me-1"></i>Tümünü Gör
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bildirim Listesi (Gizli) -->
            <div class="row" id="notification-panel" style="display: none;">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="ri-notification-3-line me-2"></i>Bildirimler
                                <button type="button" class="btn btn-sm btn-ghost-secondary float-end" onclick="toggleNotifications()">
                                    <i class="ri-close-line"></i>
                                </button>
                            </h5>
                        </div>
                        <div class="card-body p-0">
                            <div id="notifications-list" class="list-group list-group-flush">
                                <!-- Bildirimler buraya yüklenecek -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- KPI Cards Row -->
            <div class="row">
                <div class="col-xl-12">
                    <div class="card crm-widget">
                        <div class="card-body p-0">
                            <div class="row row-cols-xxl-5 row-cols-md-3 row-cols-1 g-0">
                                <div class="col">
                                    <div class="py-4 px-3">
                                        <h5 class="text-muted text-uppercase fs-13">Toplam Talepler <i class="ri-arrow-up-circle-line text-success fs-18 float-end align-middle"></i></h5>
                                        <div class="d-flex align-items-center">
                                            <div class="flex-shrink-0">
                                                <i class="ri-file-list-3-line display-6 text-muted"></i>
                                            </div>
                                            <div class="flex-grow-1 ms-3">
                                                <h2 class="mb-0"><span class="counter-value" data-target="@Model.Stats.TotalRequests">@Model.Stats.TotalRequests</span></h2>
                                            </div>
                                        </div>
                                    </div>
                                </div><!-- end col -->
                                <div class="col">
                                    <div class="mt-3 mt-md-0 py-4 px-3">
                                        <h5 class="text-muted text-uppercase fs-13">Bekleyen Talepler <i class="ri-time-line text-warning fs-18 float-end align-middle"></i></h5>
                                        <div class="d-flex align-items-center">
                                            <div class="flex-shrink-0">
                                                <i class="ri-timer-line display-6 text-muted"></i>
                                            </div>
                                            <div class="flex-grow-1 ms-3">
                                                <h2 class="mb-0"><span class="counter-value" data-target="@Model.RecentRequests.Count(r => r.Status == SantiyeTalepWebUI.Models.RequestStatus.Open)">@Model.RecentRequests.Count(r => r.Status == SantiyeTalepWebUI.Models.RequestStatus.Open)</span></h2>
                                            </div>
                                        </div>
                                    </div>
                                </div><!-- end col -->
                                <div class="col">
                                    <div class="mt-3 mt-md-0 py-4 px-3">
                                        <h5 class="text-muted text-uppercase fs-13">Tamamlanan Talepler <i class="ri-arrow-up-circle-line text-success fs-18 float-end align-middle"></i></h5>
                                        <div class="d-flex align-items-center">
                                            <div class="flex-shrink-0">
                                                <i class="ri-checkbox-circle-line display-6 text-muted"></i>
                                            </div>
                                            <div class="flex-grow-1 ms-3">
                                                <h2 class="mb-0"><span class="counter-value" data-target="@Model.RecentRequests.Count(r => r.Status == SantiyeTalepWebUI.Models.RequestStatus.Completed)">@Model.RecentRequests.Count(r => r.Status == SantiyeTalepWebUI.Models.RequestStatus.Completed)</span></h2>
                                            </div>
                                        </div>
                                    </div>
                                </div><!-- end col -->
                                <div class="col">
                                    <div class="mt-3 mt-lg-0 py-4 px-3">
                                        <h5 class="text-muted text-uppercase fs-13">Aktif Şantiyeler <i class="ri-arrow-up-circle-line text-success fs-18 float-end align-middle"></i></h5>
                                        <div class="d-flex align-items-center">
                                            <div class="flex-shrink-0">
                                                <i class="ri-building-2-line display-6 text-muted"></i>
                                            </div>
                                            <div class="flex-grow-1 ms-3">
                                                <h2 class="mb-0"><span class="counter-value" data-target="@Model.Sites.Count(s => s.IsActive)">@Model.Sites.Count(s => s.IsActive)</span></h2>
                                            </div>
                                        </div>
                                    </div>
                                </div><!-- end col -->
                                <div class="col">
                                    <div class="mt-3 mt-lg-0 py-4 px-3">
                                        <h5 class="text-muted text-uppercase fs-13">Toplam Çalışan <i class="ri-team-line text-info fs-18 float-end align-middle"></i></h5>
                                        <div class="d-flex align-items-center">
                                            <div class="flex-shrink-0">
                                                <i class="ri-group-line display-6 text-muted"></i>
                                            </div>
                                            <div class="flex-grow-1 ms-3">
                                                <h2 class="mb-0"><span class="counter-value" data-target="@Model.Stats.TotalUsers">@Model.Stats.TotalUsers</span></h2>
                                            </div>
                                        </div>
                                    </div>
                                </div><!-- end col -->
                            </div><!-- end row -->
                        </div><!-- end card body -->
                    </div><!-- end card -->
                </div><!-- end col -->
            </div><!-- end row -->
            <!-- Charts Row -->
            <div class="row">
                <div class="col-xxl-4 col-md-12">
                <div class="row">
                    <div class="col-xxl-12 col-md-12">
                        <div class="card">
                            <div class="card-header align-items-center d-flex">
                                <h4 class="card-title mb-0 flex-grow-1">Talep Durumu Dağılımı</h4>
                                <div class="flex-shrink-0">
                                    <div class="dropdown card-header-dropdown">
                                        <a class="text-reset dropdown-btn" href="#" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                            <span class="fw-semibold text-uppercase fs-12">Filtre: </span><span class="text-muted">Bu Ay<i class="mdi mdi-chevron-down ms-1"></i></span>
                                        </a>
                                        <div class="dropdown-menu dropdown-menu-end">
                                            <a class="dropdown-item" href="#">Bu Hafta</a>
                                            <a class="dropdown-item" href="#">Bu Ay</a>
                                            <a class="dropdown-item" href="#">Son 3 Ay</a>
                                            <a class="dropdown-item" href="#">Bu Yıl</a>
                                        </div>
                                    </div>
                                </div>
                            </div><!-- end card header -->
                            <div class="card-body pb-0">
                                <div id="request-status-chart" data-colors='["--vz-warning", "--vz-success", "--vz-danger", "--vz-info"]' class="apex-charts" dir="ltr"></div>
                            </div>
                        </div><!-- end card -->
                    </div><!-- end col -->
                    <div class="col-xxl-12 col-md-12">
                        <div class="card card-height-100">
                            <div class="card-header align-items-center d-flex">
                                <h4 class="card-title mb-0 flex-grow-1">Maliyet Analizi</h4>
                                <div class="flex-shrink-0">
                                    <div class="dropdown card-header-dropdown">
                                        <a class="text-reset dropdown-btn" href="#" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                            <span class="fw-semibold text-uppercase fs-12">Dönem: </span><span class="text-muted">Bu Yıl<i class="mdi mdi-chevron-down ms-1"></i></span>
                                        </a>
                                        <div class="dropdown-menu dropdown-menu-end">
                                            <a class="dropdown-item" href="#">Bu Ay</a>
                                            <a class="dropdown-item" href="#">Son 3 Ay</a>
                                            <a class="dropdown-item" href="#">Son 6 Ay</a>
                                            <a class="dropdown-item" href="#">Bu Yıl</a>
                                        </div>
                                    </div>
                                </div>
                            </div><!-- end card header -->
                            <div class="card-body px-0">
                                <ul class="list-inline main-chart text-center mb-0">
                                    <li class="list-inline-item chart-border-left me-0 border-0">
                                        <h4 class="text-primary">₺@(Model.RecentRequests.Where(r => r.Status == SantiyeTalepWebUI.Models.RequestStatus.Completed).Sum(r => (decimal?)r.EstimatedCost ?? 0).ToString("N0")) <span class="text-muted d-inline-block fs-13 align-middle ms-2">Toplam Maliyet</span></h4>
                                    </li>
                                    <li class="list-inline-item chart-border-left me-0">
                                        <h4>
                                            ₺@(Model.RecentRequests.Where(r => r.Status == SantiyeTalepWebUI.Models.RequestStatus.Completed).Sum(r => (decimal?)r.EstimatedCost ?? 0).ToString("N0"))<span class="text-muted d-inline-block fs-13 align-middle ms-2">Onaylanan</span>
                                        </h4>
                                    </li>
                                    <li class="list-inline-item chart-border-left me-0">
                                        <h4><span data-plugin="counterup">@(Model.Stats.TotalRequests > 0 ? Math.Round((double)Model.RecentRequests.Count(r => r.Status == SantiyeTalepWebUI.Models.RequestStatus.Completed) / Model.Stats.TotalRequests * 100, 0) : 0)</span>%<span class="text-muted d-inline-block fs-13 align-middle ms-2">Verimlilik</span></h4>
                                    </li>
                                </ul>

                                <div id="cost-analysis-chart" data-colors='["--vz-success", "--vz-danger"]' class="apex-charts" dir="ltr"></div>
                            </div>
                        </div><!-- end card -->
                    </div><!-- end col -->
                </div>
                </div>
                <div class="col-xxl-8 col-md-12">
                    <div class="card card-height-100">
                        <div class="card-header align-items-center d-flex">
                            <h4 class="card-title mb-0 flex-grow-1">Şantiye Performansı</h4>
                            <div class="flex-shrink-0">
                                <div class="dropdown card-header-dropdown">
                                    <a class="text-reset dropdown-btn" href="#" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        <span class="fw-semibold text-uppercase fs-12">Sıralama: </span><span class="text-muted">Aylık<i class="mdi mdi-chevron-down ms-1"></i></span>
                                    </a>
                                    <div class="dropdown-menu dropdown-menu-end">
                                        <a class="dropdown-item" href="#">Günlük</a>
                                        <a class="dropdown-item" href="#">Haftalık</a>
                                        <a class="dropdown-item" href="#">Aylık</a>
                                        <a class="dropdown-item" href="#">Yıllık</a>
                                    </div>
                                </div>
                            </div>
                        </div><!-- end card header -->
                        <div class="card-body pb-0">
                            <div id="site-performance-chart" data-colors='["--vz-primary", "--vz-success", "--vz-warning"]' class="apex-charts" dir="ltr"></div>
                        </div><!-- end card body -->
                    </div><!-- end card -->
                </div><!-- end col -->


            </div><!-- end row -->
            <!-- Data Tables Row -->
            <div class="row">
                <div class="col-xl-7">
                    <div class="card">
                        <div class="card-header align-items-center d-flex">
                            <h4 class="card-title mb-0 flex-grow-1">Son Talepler</h4>
                            <div class="flex-shrink-0">
                                <div class="dropdown card-header-dropdown">
                                    <a class="text-reset dropdown-btn" href="#" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        <span class="text-muted">Son 7 Gün<i class="mdi mdi-chevron-down ms-1"></i></span>
                                    </a>
                                    <div class="dropdown-menu dropdown-menu-end">
                                        <a class="dropdown-item" href="#">Bugün</a>
                                        <a class="dropdown-item" href="#">Son 7 Gün</a>
                                        <a class="dropdown-item" href="#">Son 30 Gün</a>
                                        <a class="dropdown-item" href="#">Bu Yıl</a>
                                    </div>
                                </div>
                            </div>
                        </div><!-- end card header -->

                        <div class="card-body">
                            <div class="table-responsive table-card">
                                <table class="table table-borderless table-hover table-nowrap align-middle mb-0">
                                    <thead class="table-light">
                                        <tr class="text-muted">
                                            <th scope="col">Talep No</th>
                                            <th scope="col" style="width: 20%;">Şantiye</th>
                                            <th scope="col">Talep Eden</th>
                                            <th scope="col" style="width: 16%;">Durum</th>
                                            <th scope="col" style="width: 12%;">Tarih</th>
                                        </tr>
                                    </thead>

                                    <tbody>
                                        @if (Model.RecentRequests?.Any() == true)
                                        {
                                            @foreach (var request in Model.RecentRequests.Take(5))
                                            {
                                                <tr>
                                                    <td>#TLP-@request.Id.ToString("D4")</td>
                                                    <td>@(request.SiteName ?? "Bilinmiyor")</td>
                                                    <td>
                                                        <img src="~/assets/images/users/avatar-1.jpg" alt="" class="avatar-xs rounded-circle me-2">
                                                        <a href="#javascript: void(0);" class="text-body fw-medium">@(request.EmployeeName ?? "Bilinmiyor")</a>
                                                    </td>
                                                    <td>
                                                        @{
                                                            var statusClass = request.Status switch
                                                            {
                                                                SantiyeTalepWebUI.Models.RequestStatus.Open => "bg-warning-subtle text-warning",
                                                                SantiyeTalepWebUI.Models.RequestStatus.Completed => "bg-success-subtle text-success",
                                                                SantiyeTalepWebUI.Models.RequestStatus.Cancelled => "bg-danger-subtle text-danger",
                                                                _ => "bg-info-subtle text-info"
                                                            };
                                                            var statusText = request.Status switch
                                                            {
                                                                SantiyeTalepWebUI.Models.RequestStatus.Open => "Açık",
                                                                SantiyeTalepWebUI.Models.RequestStatus.Completed => "Tamamlandı",
                                                                SantiyeTalepWebUI.Models.RequestStatus.Cancelled => "İptal",
                                                                _ => "İncelemede"
                                                            };
                                                        }
                                                        <span class="badge @statusClass p-2">@statusText</span>
                                                    </td>
                                                    <td>
                                                        <div class="text-nowrap">@request.RequestDate.ToString("dd MMM, yyyy")</div>
                                                    </td>
                                                </tr>
                                            }
                                        }
                                        else
                                        {
                                            <tr>
                                                <td colspan="5" class="text-center text-muted">Henüz talep bulunmuyor</td>
                                            </tr>
                                        }
                                    </tbody><!-- end tbody -->
                                </table><!-- end table -->
                            </div><!-- end table responsive -->
                        </div><!-- end card body -->
                    </div><!-- end card -->
                </div><!-- end col -->

                <div class="col-xl-5">
                    <div class="card card-height-100">
                        <div class="card-header align-items-center d-flex">
                            <h4 class="card-title mb-0 flex-grow-1">Aktif Şantiyeler</h4>
                            <div class="flex-shrink-0">
                                <select class="form-select form-select-sm" aria-label="Şantiye Filtresi">
                                    <option selected="">Tüm Şantiyeler</option>
                                    <option value="1">Aktif Projeler</option>
                                    <option value="2">Tamamlanan Projeler</option>
                                    <option value="3">Bekleyen Projeler</option>
                                </select>
                            </div>
                        </div><!-- end card header -->

                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered table-nowrap align-middle mb-0">
                                    <thead>
                                        <tr>
                                            <th scope="col" style="width: 50%;">Şantiye Adı</th>
                                            <th scope="col" style="width: 30%;">Çalışan Sayısı</th>
                                            <th scope="col" style="width: 20%;">Durum</th>
                                        </tr>
                                    </thead>

                                    <tbody>
                                        @if (Model.Sites?.Any() == true)
                                        {
                                            @foreach (var site in Model.Sites.Take(5))
                                            {
                                                <tr>
                                                    <td>@site.Name</td>
                                                    <td>
                                                        <span class="badge bg-primary">@(site.Employees?.Count ?? 0) çalışan</span>
                                                    </td>
                                                    <td>
                                                        @if (site.IsActive)
                                                        {
                                                            <span class="badge bg-success">Aktif</span>
                                                        }
                                                        else
                                                        {
                                                            <span class="badge bg-secondary">Pasif</span>
                                                        }
                                                    </td>
                                                </tr>
                                            }
                                        }
                                        else
                                        {
                                            <tr>
                                                <td colspan="3" class="text-center text-muted">Henüz şantiye bulunmuyor</td>
                                            </tr>
                                        }
                                    </tbody><!-- end tbody -->
                                </table><!-- end table -->
                            </div><!-- end table responsive -->
                        </div><!-- end card body -->
                    </div><!-- end card -->
                </div><!-- end col -->
            </div><!-- end row -->
            <!-- Employee List Row -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header align-items-center d-flex">
                            <h4 class="card-title mb-0 flex-grow-1">Son Eklenen Çalışanlar</h4>
                            <div class="flex-shrink-0">
                                <a href="@Url.Action("Employees", "Admin")" class="btn btn-primary btn-sm">Tümünü Gör</a>
                            </div>
                        </div><!-- end card header -->

                        <div class="card-body">
                            <div class="table-responsive table-card">
                                <table class="table table-borderless table-hover table-nowrap align-middle mb-0">
                                    <thead class="table-light">
                                        <tr class="text-muted">
                                            <th scope="col">Çalışan</th>
                                            <th scope="col">Şantiye</th>
                                            <th scope="col">Pozisyon</th>
                                            <th scope="col">E-posta</th>
                                            <th scope="col">Durum</th>
                                            <th scope="col">Kayıt Tarihi</th>
                                        </tr>
                                    </thead>

                                    <tbody>
                                        @if (Model.Employees?.Any() == true)
                                        {
                                            @foreach (var employee in Model.Employees.Take(5))
                                            {
                                                <tr>
                                                    <td>
                                                        <img src="~/assets/images/users/avatar-1.jpg" alt="" class="avatar-xs rounded-circle me-2">
                                                        <a href="#javascript: void(0);" class="text-body fw-medium">@employee.FullName</a>
                                                    </td>
                                                    <td>@(employee.SiteName ?? "Atanmamış")</td>
                                                    <td>@(employee.Position ?? "-")</td>
                                                    <td>@employee.Email</td>
                                                    <td>
                                                        @if (employee.IsActive)
                                                        {
                                                            <span class="badge bg-success-subtle text-success p-2">Aktif</span>
                                                        }
                                                        else
                                                        {
                                                            <span class="badge bg-danger-subtle text-danger p-2">Pasif</span>
                                                        }
                                                    </td>
                                                    <td>
                                                        <div class="text-nowrap">@employee.CreatedDate.ToString("dd MMM, yyyy")</div>
                                                    </td>
                                                </tr>
                                            }
                                        }
                                        else
                                        {
                                            <tr>
                                                <td colspan="6" class="text-center text-muted">Henüz çalışan bulunmuyor</td>
                                            </tr>
                                        }
                                    </tbody><!-- end tbody -->
                                </table><!-- end table -->
                            </div><!-- end table responsive -->
                        </div><!-- end card body -->
                    </div><!-- end card -->
                </div><!-- end col -->
            </div><!-- end row -->

        </div>
        <!-- container-fluid -->
    </div>
    <!-- End Page-content -->

    <footer class="footer">
        <div class="container-fluid">
            <div class="row">
                <div class="col-sm-6">
                    <script>document.write(new Date().getFullYear())</script> © Şantiye Talep Yönetim Sistemi.
                </div>
                <div class="col-sm-6">
                    <div class="text-sm-end d-none d-sm-block">
                        <a href="https://www.urssoft.com">UrsSoft Teknoloji A.Ş.</a> tarafından geliştirildi.
                    </div>
                </div>
            </div>
        </div>
    </footer>
</div>
<!-- end main content-->
<!-- Bildirim JavaScript'leri -->
<script>
    let notifications = [];

    // Sayfa yüklendiğinde bildirimleri kontrol et
    document.addEventListener('DOMContentLoaded', function() {
        loadNotificationSummary();
        // Her 30 saniyede bir bildirim özetini güncelle
        setInterval(loadNotificationSummary, 30000);
    });

    // Bildirim özetini yükle
    function loadNotificationSummary() {
        fetch('/Admin/GetNotificationSummary')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.summary) {
                    document.getElementById('unread-count').textContent = data.summary.unreadCount;

                    // Eğer okunmamış bildirim varsa renk değiştir
                    const badge = document.getElementById('unread-count');
                    if (data.summary.unreadCount > 0) {
                        badge.className = 'badge bg-danger me-2';
                        badge.style.display = 'inline';
                    } else {
                        badge.className = 'badge bg-success me-2';
                        badge.textContent = '0';
                        badge.style.display = 'inline';
                    }
                }
            })
            .catch(error => {
                console.error('Bildirim özeti yüklenirken hata:', error);
            });
    }

    // Bildirimleri yükle ve göster
    function loadNotifications() {
        fetch('/Admin/GetNotifications')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    notifications = data.notifications;
                    displayNotifications();

                    // Eğer hiç okunmamış bildirim yoksa paneli kapalı tut
                    const unreadCount = notifications.filter(n => !n.isRead).length;
                    if (unreadCount > 0) {
                        toggleNotifications();
                    } else {
                        // Panel zaten açıksa kapat
                        const panel = document.getElementById('notification-panel');
                        if (panel.style.display === 'block') {
                            toggleNotifications();
                        }

                        Swal.fire({
                            icon: 'info',
                            title: 'Bilgi',
                            text: 'Yeni bildirim bulunmuyor',
                            timer: 2000,
                            showConfirmButton: false
                        });
                    }
                }
            })
            .catch(error => {
                console.error('Bildirimler yüklenirken hata:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Hata!',
                    text: 'Bildirimler yüklenirken bir hata oluştu',
                    timer: 3000
                });
            });
    }

    // Bildirimleri listele
    function displayNotifications() {
        const container = document.getElementById('notifications-list');
        container.innerHTML = '';

        // Sadece okunmamış bildirimleri göster
        const unreadNotifications = notifications.filter(n => !n.isRead);

        if (unreadNotifications.length === 0) {
            container.innerHTML = `
                <div class="list-group-item text-center py-4">
                    <i class="ri-notification-off-line display-4 text-muted mb-2"></i>
                    <p class="text-muted mb-0">Yeni bildirim bulunmuyor</p>
                    <small class="text-muted">Tüm bildirimler okundu</small>
                </div>
            `;
            return;
        }

        // Okunmamış bildirimleri göster
        unreadNotifications.forEach(notification => {
            const notificationHtml = createNotificationHtml(notification);
            container.appendChild(notificationHtml);
        });

        // Eğer okunmuş bildirimler de varsa, alt kısımda bilgi ver
        const readCount = notifications.length - unreadNotifications.length;
        if (readCount > 0) {
            const infoDiv = document.createElement('div');
            infoDiv.className = 'list-group-item text-center py-2 bg-light border-top';
            infoDiv.innerHTML = `
                <small class="text-muted">
                    <i class="ri-check-double-line me-1"></i>
                    ${readCount} bildirim okundu olarak işaretlendi
                </small>
            `;
            container.appendChild(infoDiv);
        }
    }

    // Bildirim HTML'i oluştur
    function createNotificationHtml(notification) {
        const div = document.createElement('div');
        div.className = `list-group-item list-group-item-action ${!notification.isRead ? 'bg-light' : ''}`;

        const typeIcon = getNotificationIcon(notification.type);
        const typeColor = getNotificationColor(notification.type);
        const timeAgo = getTimeAgo(notification.createdDate);

        div.innerHTML = `
            <div class="d-flex w-100 justify-content-between align-items-start">
                <div class="d-flex">
                    <div class="avatar-xs me-3">
                        <div class="avatar-title ${typeColor} rounded-circle">
                            <i class="${typeIcon} fs-14"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="mb-1 ${!notification.isRead ? 'fw-bold' : ''}">${notification.title}</h6>
                        <p class="mb-1 text-muted">${notification.message}</p>
                        <small class="text-muted">${timeAgo}</small>
                        ${!notification.isRead ? '<span class="badge bg-primary ms-2">Yeni</span>' : ''}}
                    </div>
                </div>
                <div class="d-flex gap-1">
                    ${!notification.isRead ? `
                        <button class="btn btn-sm btn-outline-success" onclick="markAsRead(${notification.id})" title="Okundu İşaretle">
                            <i class="ri-check-line"></i> Okundu
                        </button>` : ''}
                    <button class="btn btn-sm btn-outline-primary" onclick="goToRelatedPage(${notification.type}, ${notification.requestId}, ${notification.offerId}, ${notification.supplierId}, ${notification.id})" title="İlgili Sayfaya Git">
                        <i class="ri-external-link-line"></i> İlgili Sayfaya Git
                    </button>
                </div>
            </div>
        `;

        // Bildirime tıklandığında okundu işaretle
        div.addEventListener('click', function(e) {
            if (!e.target.closest('.dropdown')) {
                if (!notification.isRead) {
                    markAsRead(notification.id);
                }
            }
        });

        return div;
    }

    // Bildirim tipine göre ikon döndür
    function getNotificationIcon(type) {
        switch(type) {
            case 1: return 'ri-user-add-line'; // SupplierRegistration
            case 2: return 'ri-file-add-line'; // NewRequest
            case 3: return 'ri-price-tag-3-line'; // NewOffer
            default: return 'ri-notification-3-line';
        }
    }

    // Bildirim tipine göre renk döndür
    function getNotificationColor(type) {
        switch(type) {
            case 1: return 'bg-info-subtle text-info'; // SupplierRegistration
            case 2: return 'bg-primary-subtle text-primary'; // NewRequest
            case 3: return 'bg-success-subtle text-success'; // NewOffer
            default: return 'bg-secondary-subtle text-secondary';
        }
    }

    // Zaman farkını hesapla
    function getTimeAgo(dateString) {
        const now = new Date();
        const date = new Date(dateString);
        const diffInSeconds = Math.floor((now - date) / 1000);

        if (diffInSeconds < 60) return 'Az önce';
        if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} dakika önce`;
        if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)} saat önce`;
        if (diffInSeconds < 2592000) return `${Math.floor(diffInSeconds / 86400)} gün önce`;
        return date.toLocaleDateString('tr-TR');
    }

    // Bildirimi okundu işaretle
    function markAsRead(notificationId) {
        fetch(`/Admin/MarkNotificationAsRead`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ id: notificationId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Bildirimi güncelle
                const notification = notifications.find(n => n.id === notificationId);
                if (notification) {
                    notification.isRead = true;
                }

                // Görünümü güncelle
                displayNotifications();
                loadNotificationSummary();

                // Başarı mesajı göster
                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 2000,
                    timerProgressBar: true
                });

                Toast.fire({
                    icon: 'success',
                    title: 'Bildirim okundu olarak işaretlendi'
                });
            }
        })
        .catch(error => {
            console.error('Bildirim güncellenirken hata:', error);
            Swal.fire({
                icon: 'error',
                title: 'Hata!',
                text: 'Bildirim güncellenirken bir hata oluştu',
                timer: 3000
            });
        });
    }

    // Tüm bildirimleri okundu işaretle
    function markAllAsRead() {
        const unreadNotifications = notifications.filter(n => !n.isRead);

        if (unreadNotifications.length === 0) {
            Swal.fire({
                icon: 'info',
                title: 'Bilgi',
                text: 'Zaten tüm bildirimler okunmuş durumda',
                timer: 2000,
                showConfirmButton: false
            });
            return;
        }

        fetch('/Admin/MarkAllNotificationsAsRead', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Tüm bildirimleri okundu olarak işaretle
                notifications.forEach(n => n.isRead = true);

                // Görünümü güncelle
                displayNotifications();
                loadNotificationSummary();

                // Başarı mesajı göster
                Swal.fire({
                    icon: 'success',
                    title: 'Başarılı!',
                    text: `${unreadNotifications.length} bildirim okundu olarak işaretlendi`,
                    timer: 2000,
                    showConfirmButton: false
                });
            }
        })
        .catch(error => {
            console.error('Bildirimler güncellenirken hata:', error);
            Swal.fire({
                icon: 'error',
                title: 'Hata!',
                text: 'Bildirimler güncellenirken bir hata oluştu',
                timer: 3000
            });
        });
    }

    // Bildirim panelini aç/kapat
    function toggleNotifications() {
        const panel = document.getElementById('notification-panel');
        if (panel.style.display === 'none' || panel.style.display === '') {
            panel.style.display = 'block';
           /*  panel.scrollIntoView({ behavior: 'smooth' }) */;
        } else {
            panel.style.display = 'none';
        }
    }

    // İlgili sayfaya git
    function goToRelatedPage(type, requestId, offerId, supplierId, notificationId) {
        // Önce bildirimi okundu olarak işaretle (eğer okunmamışsa)
        const notification = notifications.find(n => n.id === notificationId);
        if (notification && !notification.isRead) {
            // Async olarak okundu işaretle ama sayfaya yönlendirmeyi bekletme
            fetch(`/Admin/MarkNotificationAsRead`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ id: notificationId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Lokal olarak güncelle
                    notification.isRead = true;
                    displayNotifications();
                    loadNotificationSummary();
                }
            })
            .catch(error => {
                console.error('Bildirim güncellenirken hata:', error);
            });
        }

        // Sayfaya yönlendir
        let targetUrl = '/Admin/Dashboard';

        switch(type) {
            case 1: // SupplierRegistration
                targetUrl = '/Admin/Suppliers';
                break;
            case 2: // NewRequest
                targetUrl = '/Admin/Requests';
                break;
            case 3: // NewOffer
                targetUrl = '/Admin/Offers';
                break;
        }

        // Kısa bir gecikme ile sayfaya yönlendir (okundu işaretleme tamamlansın diye)
        setTimeout(() => {
            window.location.href = targetUrl;
        }, 100);
    }

    // Existing dashboard chart initialization code...
    // (keeping all existing chart code unchanged)

    // Initialize charts with real data
    document.addEventListener('DOMContentLoaded', function() {
        // Request Status Chart
        var openCount = @Model.RecentRequests.Count(r => r.Status == SantiyeTalepWebUI.Models.RequestStatus.Open);
        var completedCount = @Model.RecentRequests.Count(r => r.Status == SantiyeTalepWebUI.Models.RequestStatus.Completed);
        var cancelledCount = @Model.RecentRequests.Count(r => r.Status == SantiyeTalepWebUI.Models.RequestStatus.Cancelled);

        var requestStatusOptions = {
            series: [openCount, completedCount, cancelledCount],
            chart: {
                type: 'donut',
                height: 230
            },
            labels: ['Açık', 'Tamamlanan', 'İptal'],
            colors: ['#f1b44c', '#34c38f', '#f46a6a'],
            legend: {
                position: 'bottom'
            }
        };
        var requestStatusChart = new ApexCharts(document.querySelector("#request-status-chart"), requestStatusOptions);
        requestStatusChart.render();

        // Site Performance Chart (dummy data for now)
        var sitePerformanceOptions = {
            series: [{
                name: 'Talep Sayısı',
                data: [44, 55, 41, 67, 22, 43]
            }],
            chart: {
                type: 'bar',
                height: 200
            },
            xaxis: {
                categories: [@Html.Raw(string.Join(",", Model.Sites.Take(6).Select(s => "'" + s.Name + "'")))]
            },
            colors: ['#556ee6']
        };
        var sitePerformanceChart = new ApexCharts(document.querySelector("#site-performance-chart"), sitePerformanceOptions);
        sitePerformanceChart.render();

        // Cost Analysis Chart (dummy data for now)
        var costAnalysisOptions = {
            series: [{
                name: 'Onaylanan',
                data: [44, 55, 41, 67, 22, 43, 21, 49]
            }, {
                name: 'Bekleyen',
                data: [13, 23, 20, 8, 13, 27, 33, 12]
            }],
            chart: {
                type: 'area',
                height: 150
            },
            colors: ['#34c38f', '#f46a6a']
        };
        var costAnalysisChart = new ApexCharts(document.querySelector("#cost-analysis-chart"), costAnalysisOptions);
        costAnalysisChart.render();
    });

    // Show real-time status indicator after page load
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(() => {
            const statusIndicator = document.getElementById('realtimeStatus');
            if (statusIndicator) {
                statusIndicator.classList.add('active');
                // Hide after 3 seconds
                setTimeout(() => {
                    statusIndicator.classList.remove('active');
                }, 3000);
            }
        }, 2000);
    });
</script>

<!-- Real-time status indicator -->
<div class="realtime-status" id="realtimeStatus">
    <div class="status-dot"></div>
    <span>Canlı takip aktif</span>
</div>