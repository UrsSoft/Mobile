<!-- Add to your scripts section -->
<script type="text/javascript" src="~/assets/libs/toastify-js/src/toastify.js"></script>
<link rel="stylesheet" type="text/css" href="~/assets/libs/toastify-js/src/toastify.css">

<script>
// Global notification state
let lastNotificationId = 0;
let isCheckingNotifications = false;

// Initialize notification checker
document.addEventListener('DOMContentLoaded', function() {
    // Start checking for notifications
    startNotificationChecker();
});

// Start notification checker
function startNotificationChecker() {
    // Check immediately on start
    checkNotifications();
    
    // Then check every 12 seconds (average of 10-15 seconds)
    setInterval(checkNotifications, 12000);
}

// Check for new notifications
async function checkNotifications() {
    if (isCheckingNotifications) return;
    isCheckingNotifications = true;

    try {
        const response = await fetch('/Admin/GetNotificationSummary');
        const data = await response.json();

        if (data.success && data.summary) {
            // Get unread notifications
            const unreadNotifications = await getUnreadNotifications();
            
            // Show toast for each unread notification
            unreadNotifications.forEach(notification => {
                if (notification.id > lastNotificationId) {
                    showNotificationToast(notification);
                    lastNotificationId = notification.id;
                }
            });
        }
    } catch (error) {
        console.error('Notification check error:', error);
    } finally {
        isCheckingNotifications = false;
    }
}

// Get unread notifications
async function getUnreadNotifications() {
    try {
        const response = await fetch('/Admin/GetNotifications');
        const data = await response.json();
        
        if (data.success) {
            return data.notifications.filter(n => !n.isRead) || [];
        }
        return [];
    } catch (error) {
        console.error('Error getting notifications:', error);
        return [];
    }
}

// Show notification toast
function showNotificationToast(notification) {
    const toast = Toastify({
        text: `${notification.title}\n${notification.message}`,
        duration: 5000,
        gravity: "top",
        position: "right",
        stopOnFocus: true,
        close: true,
        className: `notification-toast notification-type-${notification.type}`,
        style: {
            background: getNotificationBackground(notification.type),
        },
        onClick: function() {
            // Mark as read when clicked
            markNotificationAsRead(notification.id);
            
            // Navigate to the relevant page
            const url = getNotificationUrl(notification.type, notification.requestId, 
                                        notification.offerId, notification.supplierId);
            window.location.href = url;
        }
    }).showToast();
}

// Get notification background color
function getNotificationBackground(type) {
    switch(type) {
        case 1: return "linear-gradient(to right, #00b09b, #96c93d)"; // SupplierRegistration
        case 2: return "linear-gradient(to right, #1e88e5, #1565c0)"; // NewRequest
        case 3: return "linear-gradient(to right, #ffa726, #fb8c00)"; // NewOffer
        case 4: return "linear-gradient(to right, #43a047, #2e7d32)"; // RequestApproved
        case 5: return "linear-gradient(to right, #e53935, #c62828)"; // RequestRejected
        default: return "linear-gradient(to right, #546e7a, #455a64)";
    }
}

// Mark notification as read
async function markNotificationAsRead(notificationId) {
    try {
        const response = await fetch('/Admin/MarkNotificationAsRead', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(notificationId)
        });

        const result = await response.json();
        if (result.success) {
            // Update UI if needed
            const notificationElement = document.querySelector(`[data-notification-id="${notificationId}"]`);
            if (notificationElement) {
                notificationElement.remove();
            }
            
            // Update notification counts
            loadNotificationSummary();
        }
    } catch (error) {
        console.error('Error marking notification as read:', error);
    }
}
</script>

<!-- Add toast notification styles -->
<style>
.notification-toast {
    padding: 12px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.notification-toast .toastify-content {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
}

.notification-toast .toastify-title {
    font-weight: 600;
    margin-bottom: 4px;
}

.notification-toast .toastify-message {
    font-size: 14px;
    opacity: 0.9;
}

/* Custom styles for different notification types */
.notification-type-1 { border-left: 4px solid #00b09b; }
.notification-type-2 { border-left: 4px solid #1e88e5; }
.notification-type-3 { border-left: 4px solid #ffa726; }
.notification-type-4 { border-left: 4px solid #43a047; }
.notification-type-5 { border-left: 4px solid #e53935; }
</style>